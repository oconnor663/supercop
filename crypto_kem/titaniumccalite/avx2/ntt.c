/* ****************************** *
 * Titanium_CCA_lite              *
 * Implemented by Raymond K. ZHAO *
 *                                *
 * NTT functions                  *
 * ****************************** */
 
#include "param.h"
#include "ntt.h"
#include "fastmodulo.h"
#include <stdint.h>
#include <x86intrin.h>

/* 768=3*256 */
#define N1_768 3
#define N2_768 256

/* 1280=5*256 */
#define N1_1280 5
#define N2_1280 256

/* 1536=6*256 */
#define N1_1536 6
#define N2_1536 256

/* multiplication inverses of 768, 1280, 1536 (in Montgomery form) */
#define INV_768 39083
#define INV_1280 46490
#define INV_1536 77142

/* omega_n: n-th root of unity mod Q */
static const __m256i w_3[2]={{57151,57151,57151,57151},{58049,58049,58049,58049}};

static const __m256i w_5[4][4]={{{16512,16512,16512,16512},{80578,80578,80578,80578},{47587,47587,47587,47587},{85724,85724,85724,85724}},
{{80578,80578,80578,80578},{85724,85724,85724,85724},{16512,16512,16512,16512},{47587,47587,47587,47587}},
{{47587,47587,47587,47587},{16512,16512,16512,16512},{85724,85724,85724,85724},{80578,80578,80578,80578}},
{{85724,85724,85724,85724},{47587,47587,47587,47587},{80578,80578,80578,80578},{16512,16512,16512,16512}}};

static const __m256i w_6[5][5]={{{57152,57152,57152,57152},{57151,57151,57151,57151},{115200,115200,115200,115200},{58049,58049,58049,58049},{58050,58050,58050,58050}},
{{57151,57151,57151,57151},{58049,58049,58049,58049},{1,1,1,1},{57151,57151,57151,57151},{58049,58049,58049,58049}},
{{115200,115200,115200,115200},{1,1,1,1},{115200,115200,115200,115200},{1,1,1,1},{115200,115200,115200,115200}},
{{58049,58049,58049,58049},{57151,57151,57151,57151},{1,1,1,1},{58049,58049,58049,58049},{57151,57151,57151,57151}},
{{58050,58050,58050,58050},{58049,58049,58049,58049},{115200,115200,115200,115200},{57151,57151,57151,57151},{57152,57152,57152,57152}}};

/* omega_256,768,1280,1536, respectively (in Montgomery form) */
static const uint64_t omega_256[128]={63484,3179,100667,115043,30039,62881,23765,22024,5233,55763,103997,66697,6971,70937,103512,35684,110310,13374,66124,43727,67849,51894,92224,57105,20928,105695,60311,20947,735,50562,65482,43292,63786,50756,54847,71077,63771,42671,74670,41981,48363,32231,92359,14669,72923,21956,83782,114907,71936,65968,74844,20566,25778,70222,63730,20572,29012,85333,29288,3695,33188,32177,63253,109072,37298,58648,46198,17306,111854,39183,37854,12729,64072,89709,83932,80556,104108,11325,113723,9765,79290,112940,48532,8121,114782,4561,39158,24379,7367,53979,64029,66532,33237,58588,13858,96598,110671,92752,111295,83485,70025,72748,42832,46248,44256,7377,59369,89214,47529,43509,65548,78866,114806,17497,99602,1812,55060,70683,81807,87191,109142,75028,4541,28378,89210,45373,33435,50109};
static const uint64_t omega_768[768]={63484,84859,51811,3179,4204,47487,100667,77137,20871,115043,104483,74972,30039,98249,89558,62881,78952,2543,23765,45959,103466,22024,3686,10890,5233,28337,109660,55763,67111,8627,103997,114916,41913,66697,76787,11711,6971,31034,91375,70937,23181,60298,103512,52851,13940,35684,32042,25595,110310,105689,86786,13374,57077,6048,66124,5836,34244,43727,35177,25356,67849,67439,73166,51894,61306,37732,92224,96448,62172,57105,29821,102418,20928,60580,22023,105695,50737,4694,60311,44606,110845,20947,80826,71337,735,19236,88710,50562,114,6275,65482,61446,41396,43292,56707,78651,63786,36808,114122,50756,24940,109625,54847,79344,104963,71077,26845,11366,63771,69330,20621,42671,43746,55423,74670,78090,35938,41981,42145,16814,48363,21558,77068,32231,99662,67292,92359,34152,97274,14669,90969,14231,72923,71866,67243,21956,28238,70863,83782,13750,63626,114907,38386,79717,71936,69075,112691,65968,21502,29522,74844,69478,14620,20566,8317,46512,25778,105225,71351,70222,37383,96256,63730,104463,41534,20572,87469,37832,29012,28582,871,85333,83965,8665,29288,98343,62395,3695,14417,107414,33188,52296,65244,32177,78500,30211,63253,32733,40388,109072,17334,111344,37298,11745,109896,58648,109701,20630,46198,30726,60274,17306,87571,1004,111854,83560,80352,39183,110450,109353,37854,88834,73556,12729,73111,17540,64072,8087,7578,89709,96456,52507,83932,34133,77028,80556,80728,45732,104108,81615,111735,11325,98904,90243,113723,86394,26155,9765,25162,43023,79290,83801,33996,112940,9947,6885,48532,62187,24583,8121,110503,2122,114782,2200,106949,4561,33790,45011,39158,11052,68719,24379,81777,60020,7367,71021,94500,53979,33587,16658,64029,16836,108185,66532,88926,20009,33237,7498,71158,58588,9387,107430,13858,105950,73868,96598,82555,70507,110671,29559,102144,92752,34563,104739,111295,82096,5831,83485,12560,32482,70025,88182,112447,72748,67286,13207,42832,94040,91312,46248,114321,26341,44256,101685,28076,7377,87740,41633,59369,59450,91193,89214,17672,77401,47529,78726,16377,43509,39346,71927,65548,10510,61117,78866,20041,109778,114806,88406,72229,17497,72821,108694,99602,82179,63958,1812,57297,28263,55060,9215,27225,70683,13242,43748,81807,110177,79168,87191,56888,47182,109142,19166,86878,75028,77585,55636,4541,352,35544,28378,74527,34850,89210,80105,6387,45373,91421,101764,33435,85092,15120,50109,14590,85610,51717,30342,63390,112022,110997,67714,14534,38064,94330,158,10718,40229,85162,16952,25643,52320,36249,112658,91436,69242,11735,93177,111515,104311,109968,86864,5541,59438,48090,106574,11204,285,73288,48504,38414,103490,108230,84167,23826,44264,92020,54903,11689,62350,101261,79517,83159,89606,4891,9512,28415,101827,58124,109153,49077,109365,80957,71474,80024,89845,47352,47762,42035,63307,53895,77469,22977,18753,53029,58096,85380,12783,94273,54621,93178,9506,64464,110507,54890,70595,4356,94254,34375,43864,114466,95965,26491,64639,115087,108926,49719,53755,73805,71909,58494,36550,51415,78393,1079,64445,90261,5576,60354,35857,10238,44124,88356,103835,51430,45871,94580,72530,71455,59778,40531,37111,79263,73220,73056,98387,66838,93643,38133,82970,15539,47909,22842,81049,17927,100532,24232,100970,42278,43335,47958,93245,86963,44338,31419,101451,51575,294,76815,35484,43265,46126,2510,49233,93699,85679,40357,45723,100581,94635,106884,68689,89423,9976,43850,44979,77818,18945,51471,10738,73667,94629,27732,77369,86189,86619,114330,29868,31236,106536,85913,16858,52806,111506,100784,7787,82013,62905,49957,83024,36701,84990,51948,82468,74813,6129,97867,3857,77903,103456,5305,56553,5500,94571,69003,84475,54927,97895,27630,114197,3347,31641,34849,76018,4751,5848,77347,26367,41645,102472,42090,97661,51129,107114,107623,25492,18745,62694,31269,81068,38173,34645,34473,69469,11093,33586,3466,103876,16297,24958,1478,28807,89046,105436,90039,72178,35911,31400,81205,2261,105254,108316,66669,53014,90618,107080,4698,113079,419,113001,8252,110640,81411,70190,76043,104149,46482,90822,33424,55181,107834,44180,20701,61222,81614,98543,51172,98365,7016,48669,26275,95192,81964,107703,44043,56613,105814,7771,101343,9251,41333,18603,32646,44694,4530,85642,13057,22449,80638,10462,3906,33105,109370,31716,102641,82719,45176,27019,2754,42453,47915,101994,72369,21161,23889,68953,880,88860,70945,13516,87125,107824,27461,73568,55832,55751,24008,25987,97529,37800,67672,36475,98824,71692,75855,43274,49653,104691,54084,36335,95160,5423,395,26795,42972,97704,42380,6507,15599,33022,51243,113389,57904,86938,60141,105986,87976,44518,101959,71453,33394,5024,36033,28010,58313,68019,6059,96035,28323,40173,37616,59565,110660,114849,79657,86823,40674,80351,25991,35096,108814,69828,23780,13437,81766,30109,100081,65092,100611,29591};
static const uint64_t omega_1280[1280]={63484,88024,14427,3672,7690,3179,97325,57686,20791,112875,100667,41720,103685,31852,13497,115043,22885,13730,3279,17220,30039,8508,27606,39366,65500,62881,92973,18705,21290,52994,23765,12,59508,70411,109119,22024,6468,48934,50400,62631,5233,30222,109598,93365,4216,55763,46317,90410,96099,83605,103997,81447,967,72112,19504,66697,8352,60409,45631,29365,6971,8889,73769,57296,45198,70937,67930,17146,8676,54311,103512,95553,25614,68324,12575,35684,8220,97027,77517,96267,110310,52942,111500,78901,47463,13374,81091,78779,18470,7935,66124,46870,67913,48044,14528,43727,33911,86390,90692,112125,67849,76271,23006,37764,70051,51894,98513,73727,79420,86762,92224,106047,109709,67809,108313,57105,19637,35038,30334,89001,20928,101052,107719,106685,47923,105695,92156,114438,17916,25473,60311,20453,49547,95041,21028,20947,80072,94402,77855,44394,735,73634,79037,30681,81759,50562,59582,91774,63316,61319,65482,88820,44957,27828,103455,43292,65565,39613,23162,4961,63786,88029,39222,42610,24356,50756,100020,58875,41791,110171,54847,111913,53350,61154,53654,71077,70984,70601,14520,4055,63771,13644,37609,107813,112027,42671,96453,111076,49903,17229,74670,32516,80645,55884,70351,41981,15572,36878,54015,18060,48363,98836,62670,83433,57456,32231,49742,25237,41997,94916,92359,84306,9025,56987,10480,14669,51740,26033,72527,3871,72923,9218,92466,38914,12851,21956,14859,72342,8064,14629,83782,60132,54400,84059,51363,114907,39667,60546,33808,36417,71936,68328,32411,20754,44593,65968,79673,74178,11909,73819,74844,88975,7195,82896,44096,20566,33909,76472,98157,36338,25778,75193,91651,29364,2012,70222,93476,93861,44659,47659,63730,40727,17840,109393,113579,20572,63663,54077,95116,47350,29012,99660,1650,3079,62229,85333,33074,82943,46767,17940,29288,85932,8289,93595,107977,3695,6546,90133,104868,23098,33188,72264,82066,75362,8114,32177,12358,111591,69366,111009,63253,94505,12627,63150,44532,109072,19353,9094,53555,40940,37298,63177,63224,65895,63269,58648,68108,93441,35497,2495,46198,76294,21862,9517,77594,17306,110910,33116,60819,5203,111854,106372,108570,64357,39593,39183,79611,112323,12922,28442,37854,55557,61572,52898,8505,12729,108164,9420,57375,91356,64072,8690,8536,51257,50057,89709,75870,108065,94484,23689,83932,112776,70530,8034,96261,80556,75337,114541,67889,44229,104108,55891,105064,73454,108025,11325,57788,65805,77763,48970,113723,43462,102188,96294,13801,9765,40215,13254,62016,65875,79290,18097,1444,18334,24717,112940,77399,87110,89941,74348,48532,15299,65483,93779,98825,8121,66890,43831,88843,43813,114782,110998,8704,77962,114203,4561,38603,83416,88354,38083,39158,70837,32834,44793,20959,24379,49612,71773,66418,7203,7367,14236,93312,86992,80784,53979,69938,67532,1881,111799,64029,25855,111433,92251,9538,66532,111725,42666,71658,72138,33237,84853,71975,31327,59645,58588,970,86989,65907,7576,13858,62026,264,41965,51429,96598,23724,27095,39739,71991,110671,115126,88879,107136,95613,92752,74776,97366,30603,40560,111295,99115,63819,21274,88851,83485,84922,68543,61787,82274,70025,38161,80357,10104,108502,72748,63001,112048,31609,75671,42832,88445,28548,102704,5515,46248,93842,65639,60976,92560,44256,7599,12714,33779,7807,7377,63826,55987,5123,60737,59369,72316,109532,111674,20159,89214,40386,54836,57364,36807,47529,110266,65148,45328,24401,43509,104859,93668,9180,19225,65548,70511,29014,109578,109386,78866,104300,86411,79630,91343,114806,114813,34325,65798,43050,17497,21270,69015,98415,48549,99602,59631,104363,53225,17284,1812,30,33569,3226,99996,55060,16170,7134,10799,98977,70683,75555,43593,60611,10540,81807,58192,110824,67446,36211,87191,30816,60018,65079,48760,109142,20880,93422,56477,15812,75028,79823,11621,28039,112995,4541,54624,42865,21690,78177,28378,66081,64035,55609,89038,89210,20550,69766,20991,67866,45373,17154,48348,24451,61057,33435,29926,24146,46175,77438,50109,1974,112182,4909,36320,51717,27177,100774,111529,107511,112022,17876,57515,94410,2326,14534,73481,11516,83349,101704,158,92316,101471,111922,97981,85162,106693,87595,75835,49701,52320,22228,96496,93911,62207,91436,115189,55693,44790,6082,93177,108733,66267,64801,52570,109968,84979,5603,21836,110985,59438,68884,24791,19102,31596,11204,33754,114234,43089,95697,48504,106849,54792,69570,85836,108230,106312,41432,57905,70003,44264,47271,98055,106525,60890,11689,19648,89587,46877,102626,79517,106981,18174,37684,18934,4891,62259,3701,36300,67738,101827,34110,36422,96731,107266,49077,68331,47288,67157,100673,71474,81290,28811,24509,3076,47352,38930,92195,77437,45150,63307,16688,41474,35781,28439,22977,9154,5492,47392,6888,58096,95564,80163,84867,26200,94273,14149,7482,8516,67278,9506,23045,763,97285,89728,54890,94748,65654,20160,94173,94254,35129,20799,37346,70807,114466,41567,36164,84520,33442,64639,55619,23427,51885,53882,49719,26381,70244,87373,11746,71909,49636,75588,92039,110240,51415,27172,75979,72591,90845,64445,15181,56326,73410,5030,60354,3288,61851,54047,61547,44124,44217,44600,100681,111146,51430,101557,77592,7388,3174,72530,18748,4125,65298,97972,40531,82685,34556,59317,44850,73220,99629,78323,61186,97141,66838,16365,52531,31768,57745,82970,65459,89964,73204,20285,22842,30895,106176,58214,104721,100532,63461,89168,42674,111330,42278,105983,22735,76287,102350,93245,100342,42859,107137,100572,31419,55069,60801,31142,63838,294,75534,54655,81393,78784,43265,46873,82790,94447,70608,49233,35528,41023,103292,41382,40357,26226,108006,32305,71105,94635,81292,38729,17044,78863,89423,40008,23550,85837,113189,44979,21725,21340,70542,67542,51471,74474,97361,5808,1622,94629,51538,61124,20085,67851,86189,15541,113551,112122,52972,29868,82127,32258,68434,97261,85913,29269,106912,21606,7224,111506,108655,25068,10333,92103,82013,42937,33135,39839,107087,83024,102843,3610,45835,4192,51948,20696,102574,52051,70669,6129,95848,106107,61646,74261,77903,52024,51977,49306,51932,56553,47093,21760,79704,112706,69003,38907,93339,105684,37607,97895,4291,82085,54382,109998,3347,8829,6631,50844,75608,76018,35590,2878,102279,86759,77347,59644,53629,62303,106696,102472,7037,105781,57826,23845,51129,106511,106665,63944,65144,25492,39331,7136,20717,91512,31269,2425,44671,107167,18940,34645,39864,660,47312,70972,11093,59310,10137,41747,7176,103876,57413,49396,37438,66231,1478,71739,13013,18907,101400,105436,74986,101947,53185,49326,35911,97104,113757,96867,90484,2261,37802,28091,25260,40853,66669,99902,49718,21422,16376,107080,48311,71370,26358,71388,419,4203,106497,37239,998,110640,76598,31785,26847,77118,76043,44364,82367,70408,94242,90822,65589,43428,48783,107998,107834,100965,21889,28209,34417,61222,45263,47669,113320,3402,51172,89346,3768,22950,105663,48669,3476,72535,43543,43063,81964,30348,43226,83874,55556,56613,114231,28212,49294,107625,101343,53175,114937,73236,63772,18603,91477,88106,75462,43210,4530,75,26322,8065,19588,22449,40425,17835,84598,74641,3906,16086,51382,93927,26350,31716,30279,46658,53414,32927,45176,77040,34844,105097,6699,42453,52200,3153,83592,39530,72369,26756,86653,12497,109686,68953,21359,49562,54225,22641,70945,107602,102487,81422,107394,107824,51375,59214,110078,54464,55832,42885,5669,3527,95042,25987,74815,60365,57837,78394,67672,4935,50053,69873,90800,71692,10342,21533,106021,95976,49653,44690,86187,5623,5815,36335,10901,28790,35571,23858,395,388,80876,49403,72151,97704,93931,46186,16786,66652,15599,55570,10838,61976,97917,113389,115171,81632,111975,15205,60141,99031,108067,104402,16224,44518,39646,71608,54590,104661,33394,57009,4377,47755,78990,28010,84385,55183,50122,66441,6059,94321,21779,58724,99389,40173,35378,103580,87162,2206,110660,60577,72336,93511,37024,86823,49120,51166,59592,26163,25991,94651,45435,94210,47335,69828,98047,66853,90750,54144,81766,85275,91055,69026,37763,65092,113227,3019,110292,78881};
static const uint64_t omega_1536[1536]={63484,81905,84859,20581,51811,90996,3179,24812,4204,33863,47487,86419,100667,10352,77137,50399,20871,38637,115043,50080,104483,92826,74972,89163,30039,36086,98249,35980,89558,20040,62881,96586,78952,39452,2543,87867,23765,104203,45959,67644,103466,12702,22024,62530,3686,56600,10890,49519,5233,64978,28337,94336,109660,79310,55763,2038,67111,43463,8627,8519,103997,61673,114916,40754,41913,98902,66697,63859,76787,78216,11711,85316,6971,90103,31034,110059,91375,20125,70937,65896,23181,108487,60298,18481,103512,36036,52851,67586,13940,53973,35684,69636,32042,25338,25595,60795,110310,93479,105689,63464,86786,51421,13374,42344,57077,107600,6048,67679,66124,13618,5836,50297,34244,75465,43727,82439,35177,37848,25356,9682,67849,82236,67439,9495,73166,34553,51894,88020,61306,48961,37732,76706,92224,95169,96448,8950,62172,102576,57105,31646,29821,100809,102418,107185,20928,7446,60580,76380,22023,57014,105695,96560,50737,42063,4694,87080,60311,90189,44606,92561,110845,49313,20947,112250,80826,8346,71337,83477,735,22225,19236,5655,88710,65713,50562,113572,114,52819,6275,52600,65482,43577,61446,14794,41396,11954,43292,102200,56707,25097,78651,107151,63786,19722,36808,48766,114122,38688,50756,31666,24940,19046,109625,1451,54847,18226,79344,12905,104963,90883,71077,31729,26845,43735,11366,25512,63771,52183,69330,72161,20621,42049,42671,17593,43746,72042,55423,85015,74670,36145,78090,7901,35938,88288,41981,13186,42145,111403,16814,9219,48363,79993,21558,26496,77068,15398,32231,31053,99662,111621,67292,5050,92359,33422,34152,28797,97274,72327,14669,43102,90969,84649,14231,46315,72923,76577,71866,6215,67243,80369,21956,33045,28238,9056,70863,3315,83782,70301,13750,42742,63626,58770,114907,106311,38386,112939,79717,111956,71936,46732,69075,47993,112691,94161,65968,74730,21502,63203,29522,64339,74844,74321,69478,82122,14620,3220,20566,84272,8317,26574,46512,7565,25778,33414,105225,38462,71351,45500,70222,38790,37383,110039,96256,101888,63730,56429,104463,97707,41534,81956,20572,2167,87469,17216,37832,52301,29012,16003,28582,63344,871,81195,85333,100743,83965,42920,8665,102926,29288,40806,98343,93680,62395,65433,3695,106244,14417,35482,107414,16881,33188,10619,52296,1432,65244,113181,32177,78792,78500,80642,30211,63230,63253,74920,32733,35261,40388,96675,109072,61530,17334,112715,111344,36973,37298,101983,11745,42458,109896,113875,58648,17960,109701,75064,20630,91693,46198,3556,30726,23945,60274,1298,17306,73468,87571,3843,1004,8416,111854,85309,83560,112960,80352,43385,39183,16352,110450,59312,109353,113913,37854,58452,88834,58491,73556,112175,12729,55755,73111,76776,17540,97001,64072,99685,8087,25105,7578,97486,89709,46549,96456,53078,52507,13298,83932,91294,34133,39194,77028,25160,80556,16639,80728,43783,45732,82723,104108,97944,81615,98033,111735,4910,11325,29758,98904,77729,90243,112068,113723,26623,86394,77968,26155,39328,9765,64873,25162,91588,43023,808,79290,60644,83801,59904,33996,89909,112940,85233,9947,31976,6885,76531,48532,90589,62187,70115,24583,8251,8121,97448,110503,6057,2122,69651,114782,108017,2200,39095,106949,101564,4561,44658,33790,105623,45011,22521,39158,108854,11052,21503,68719,42714,24379,34997,81777,70017,60020,97847,7367,85620,71021,68436,94500,92676,53979,68780,33587,22684,16658,70331,64029,92899,16836,15370,108185,7280,66532,75327,88926,105159,20009,7086,33237,50501,7498,1809,71158,17721,58588,32603,9387,53443,107430,105137,13858,62465,105950,5527,73868,105152,96598,29943,82555,99028,70507,113237,110671,11137,29559,38029,102144,93414,92752,12391,34563,107054,104739,7309,111295,112292,82096,101606,5831,22717,83485,44863,12560,45159,32482,33157,70025,104148,88182,33290,112447,15468,72748,32885,67286,87155,13207,42780,42832,99262,94040,89738,91312,18220,46248,48954,114321,99563,26341,28495,44256,5177,101685,95992,28076,37072,7377,25579,87740,14439,41633,52035,59369,78162,59450,64154,91193,53022,89214,80953,17672,18706,77401,9010,47529,87689,78726,60047,16377,17948,43509,31961,39346,109053,71927,112289,65548,62030,10510,27057,61117,43246,78866,25880,20041,68397,109778,38992,114806,9999,88406,1663,72229,50106,17497,90215,72821,89950,108694,50100,99602,11063,82179,98630,63958,46866,1812,87706,57297,53909,28263,31755,55060,41124,9215,26299,27225,66197,70683,47244,13242,5438,43748,83074,81807,5095,110177,51057,79168,78898,87191,96582,56888,101885,47182,16853,109142,102047,19166,80339,86878,98089,75028,52456,77585,102346,55636,107913,4541,49539,352,98416,35544,103803,28378,90090,74527,53764,34850,77332,89210,58889,80105,63345,6387,94387,45373,60896,91421,43459,101764,70952,33435,105860,85092,38598,15120,111597,50109,34045,14590,68142,85610,15861,51717,33296,30342,94620,63390,24205,112022,90389,110997,81338,67714,28782,14534,104849,38064,64802,94330,76564,158,65121,10718,22375,40229,26038,85162,79115,16952,79221,25643,95161,52320,18615,36249,75749,112658,27334,91436,10998,69242,47557,11735,102499,93177,52671,111515,58601,104311,65682,109968,50223,86864,20865,5541,35891,59438,113163,48090,71738,106574,106682,11204,53528,285,74447,73288,16299,48504,51342,38414,36985,103490,29885,108230,25098,84167,5142,23826,95076,44264,49305,92020,6714,54903,96720,11689,79165,62350,47615,101261,61228,79517,45565,83159,89863,89606,54406,4891,21722,9512,51737,28415,63780,101827,72857,58124,7601,109153,47522,49077,101583,109365,64904,80957,39736,71474,32762,80024,77353,89845,105519,47352,32965,47762,105706,42035,80648,63307,27181,53895,66240,77469,38495,22977,20032,18753,106251,53029,12625,58096,83555,85380,14392,12783,8016,94273,107755,54621,38821,93178,58187,9506,18641,64464,73138,110507,28121,54890,25012,70595,22640,4356,65888,94254,2951,34375,106855,43864,31724,114466,92976,95965,109546,26491,49488,64639,1629,115087,62382,108926,62601,49719,71624,53755,100407,73805,103247,71909,13001,58494,90104,36550,8050,51415,95479,78393,66435,1079,76513,64445,83535,90261,96155,5576,113750,60354,96975,35857,102296,10238,24318,44124,83472,88356,71466,103835,89689,51430,63018,45871,43040,94580,73152,72530,97608,71455,43159,59778,30186,40531,79056,37111,107300,79263,26913,73220,102015,73056,3798,98387,105982,66838,35208,93643,88705,38133,99803,82970,84148,15539,3580,47909,110151,22842,81779,81049,86404,17927,42874,100532,72099,24232,30552,100970,68886,42278,38624,43335,108986,47958,34832,93245,82156,86963,106145,44338,111886,31419,44900,101451,72459,51575,56431,294,8890,76815,2262,35484,3245,43265,68469,46126,67208,2510,21040,49233,40471,93699,51998,85679,50862,40357,40880,45723,33079,100581,111981,94635,30929,106884,88627,68689,107636,89423,81787,9976,76739,43850,69701,44979,76411,77818,5162,18945,13313,51471,58772,10738,17494,73667,33245,94629,113034,27732,97985,77369,62900,86189,99198,86619,51857,114330,34006,29868,14458,31236,72281,106536,12275,85913,74395,16858,21521,52806,49768,111506,8957,100784,79719,7787,98320,82013,104582,62905,113769,49957,2020,83024,36409,36701,34559,84990,51971,51948,40281,82468,79940,74813,18526,6129,53671,97867,2486,3857,78228,77903,13218,103456,72743,5305,1326,56553,97241,5500,40137,94571,23508,69003,111645,84475,91256,54927,113903,97895,41733,27630,111358,114197,106785,3347,29892,31641,2241,34849,71816,76018,98849,4751,55889,5848,1288,77347,56749,26367,56710,41645,3026,102472,59446,42090,38425,97661,18200,51129,15516,107114,90096,107623,17715,25492,68652,18745,62123,62694,101903,31269,23907,81068,76007,38173,90041,34645,98562,34473,71418,69469,32478,11093,17257,33586,17168,3466,110291,103876,85443,16297,37472,24958,3133,1478,88578,28807,37233,89046,75873,105436,50328,90039,23613,72178,114393,35911,54557,31400,55297,81205,25292,2261,29968,105254,83225,108316,38670,66669,24612,53014,45086,90618,106950,107080,17753,4698,109144,113079,45550,419,7184,113001,76106,8252,13637,110640,70543,81411,9578,70190,92680,76043,6347,104149,93698,46482,72487,90822,80204,33424,45184,55181,17354,107834,29581,44180,46765,20701,22525,61222,46421,81614,92517,98543,44870,51172,22302,98365,99831,7016,107921,48669,39874,26275,10042,95192,108115,81964,64700,107703,113392,44043,97480,56613,82598,105814,61758,7771,10064,101343,52736,9251,109674,41333,10049,18603,85258,32646,16173,44694,1964,4530,104064,85642,77172,13057,21787,22449,102810,80638,8147,10462,107892,3906,2909,33105,13595,109370,92484,31716,70338,102641,70042,82719,82044,45176,11053,27019,81911,2754,99733,42453,82316,47915,28046,101994,72421,72369,15939,21161,25463,23889,96981,68953,66247,880,15638,88860,86706,70945,110024,13516,19209,87125,78129,107824,89622,27461,100762,73568,63166,55832,37039,55751,51047,24008,62179,25987,34248,97529,96495,37800,106191,67672,27512,36475,55154,98824,97253,71692,83240,75855,6148,43274,2912,49653,53171,104691,88144,54084,71955,36335,89321,95160,46804,5423,76209,395,105202,26795,113538,42972,65095,97704,24986,42380,25251,6507,65101,15599,104138,33022,16571,51243,68335,113389,27495,57904,61292,86938,83446,60141,74077,105986,88902,87976,49004,44518,67957,101959,109763,71453,32127,33394,110106,5024,64144,36033,36303,28010,18619,58313,13316,68019,98348,6059,13154,96035,34862,28323,17112,40173,62745,37616,12855,59565,7288,110660,65662,114849,16785,79657,11398,86823,25111,40674,61437,80351,37869,25991,56312,35096,51856,108814,20814,69828,54305,23780,71742,13437,44249,81766,9341,30109,76603,100081,3604,65092,81156,100611,47059,29591,99340};

/* multiplication inverses of omega */
static const __m256i w_3_inv[2]={{58049,58049,58049,58049},{57151,57151,57151,57151}};

static const __m256i w_5_inv[4][4]={{{85724,85724,85724,85724},{47587,47587,47587,47587},{80578,80578,80578,80578},{16512,16512,16512,16512}},
{{47587,47587,47587,47587},{16512,16512,16512,16512},{85724,85724,85724,85724},{80578,80578,80578,80578}},
{{80578,80578,80578,80578},{85724,85724,85724,85724},{16512,16512,16512,16512},{47587,47587,47587,47587}},
{{16512,16512,16512,16512},{80578,80578,80578,80578},{47587,47587,47587,47587},{85724,85724,85724,85724}}};

/* (in Montgomery form) */
static const uint64_t omega_256_inv[128]={63484,65092,81766,69828,25991,86823,110660,40173,6059,28010,33394,44518,60141,113389,15599,97704,395,36335,49653,71692,67672,25987,55832,107824,70945,68953,72369,42453,45176,31716,3906,22449,4530,18603,101343,56613,81964,48669,51172,61222,107834,90822,76043,110640,419,107080,66669,2261,35911,105436,1478,103876,11093,34645,31269,25492,51129,102472,77347,76018,3347,97895,69003,56553,77903,6129,51948,83024,82013,111506,85913,29868,86189,94629,51471,44979,89423,94635,40357,49233,43265,294,31419,93245,42278,100532,22842,82970,66838,73220,40531,72530,51430,44124,60354,64445,51415,71909,49719,64639,114466,94254,54890,9506,94273,58096,22977,63307,47352,71474,49077,101827,4891,79517,11689,44264,108230,48504,11204,59438,109968,93177,91436,52320,85162,158,14534,112022};
static const uint64_t omega_768_inv[768]={63484,29591,100611,65092,100081,30109,81766,13437,23780,69828,108814,35096,25991,80351,40674,86823,79657,114849,110660,59565,37616,40173,28323,96035,6059,68019,58313,28010,36033,5024,33394,71453,101959,44518,87976,105986,60141,86938,57904,113389,51243,33022,15599,6507,42380,97704,42972,26795,395,5423,95160,36335,54084,104691,49653,43274,75855,71692,98824,36475,67672,37800,97529,25987,24008,55751,55832,73568,27461,107824,87125,13516,70945,88860,880,68953,23889,21161,72369,101994,47915,42453,2754,27019,45176,82719,102641,31716,109370,33105,3906,10462,80638,22449,13057,85642,4530,44694,32646,18603,41333,9251,101343,7771,105814,56613,44043,107703,81964,95192,26275,48669,7016,98365,51172,98543,81614,61222,20701,44180,107834,55181,33424,90822,46482,104149,76043,70190,81411,110640,8252,113001,419,113079,4698,107080,90618,53014,66669,108316,105254,2261,81205,31400,35911,72178,90039,105436,89046,28807,1478,24958,16297,103876,3466,33586,11093,69469,34473,34645,38173,81068,31269,62694,18745,25492,107623,107114,51129,97661,42090,102472,41645,26367,77347,5848,4751,76018,34849,31641,3347,114197,27630,97895,54927,84475,69003,94571,5500,56553,5305,103456,77903,3857,97867,6129,74813,82468,51948,84990,36701,83024,49957,62905,82013,7787,100784,111506,52806,16858,85913,106536,31236,29868,114330,86619,86189,77369,27732,94629,73667,10738,51471,18945,77818,44979,43850,9976,89423,68689,106884,94635,100581,45723,40357,85679,93699,49233,2510,46126,43265,35484,76815,294,51575,101451,31419,44338,86963,93245,47958,43335,42278,100970,24232,100532,17927,81049,22842,47909,15539,82970,38133,93643,66838,98387,73056,73220,79263,37111,40531,59778,71455,72530,94580,45871,51430,103835,88356,44124,10238,35857,60354,5576,90261,64445,1079,78393,51415,36550,58494,71909,73805,53755,49719,108926,115087,64639,26491,95965,114466,43864,34375,94254,4356,70595,54890,110507,64464,9506,93178,54621,94273,12783,85380,58096,53029,18753,22977,77469,53895,63307,42035,47762,47352,89845,80024,71474,80957,109365,49077,109153,58124,101827,28415,9512,4891,89606,83159,79517,101261,62350,11689,54903,92020,44264,23826,84167,108230,103490,38414,48504,73288,285,11204,106574,48090,59438,5541,86864,109968,104311,111515,93177,11735,69242,91436,112658,36249,52320,25643,16952,85162,40229,10718,158,94330,38064,14534,67714,110997,112022,63390,30342,51717,85610,14590,50109,15120,85092,33435,101764,91421,45373,6387,80105,89210,34850,74527,28378,35544,352,4541,55636,77585,75028,86878,19166,109142,47182,56888,87191,79168,110177,81807,43748,13242,70683,27225,9215,55060,28263,57297,1812,63958,82179,99602,108694,72821,17497,72229,88406,114806,109778,20041,78866,61117,10510,65548,71927,39346,43509,16377,78726,47529,77401,17672,89214,91193,59450,59369,41633,87740,7377,28076,101685,44256,26341,114321,46248,91312,94040,42832,13207,67286,72748,112447,88182,70025,32482,12560,83485,5831,82096,111295,104739,34563,92752,102144,29559,110671,70507,82555,96598,73868,105950,13858,107430,9387,58588,71158,7498,33237,20009,88926,66532,108185,16836,64029,16658,33587,53979,94500,71021,7367,60020,81777,24379,68719,11052,39158,45011,33790,4561,106949,2200,114782,2122,110503,8121,24583,62187,48532,6885,9947,112940,33996,83801,79290,43023,25162,9765,26155,86394,113723,90243,98904,11325,111735,81615,104108,45732,80728,80556,77028,34133,83932,52507,96456,89709,7578,8087,64072,17540,73111,12729,73556,88834,37854,109353,110450,39183,80352,83560,111854,1004,87571,17306,60274,30726,46198,20630,109701,58648,109896,11745,37298,111344,17334,109072,40388,32733,63253,30211,78500,32177,65244,52296,33188,107414,14417,3695,62395,98343,29288,8665,83965,85333,871,28582,29012,37832,87469,20572,41534,104463,63730,96256,37383,70222,71351,105225,25778,46512,8317,20566,14620,69478,74844,29522,21502,65968,112691,69075,71936,79717,38386,114907,63626,13750,83782,70863,28238,21956,67243,71866,72923,14231,90969,14669,97274,34152,92359,67292,99662,32231,77068,21558,48363,16814,42145,41981,35938,78090,74670,55423,43746,42671,20621,69330,63771,11366,26845,71077,104963,79344,54847,109625,24940,50756,114122,36808,63786,78651,56707,43292,41396,61446,65482,6275,114,50562,88710,19236,735,71337,80826,20947,110845,44606,60311,4694,50737,105695,22023,60580,20928,102418,29821,57105,62172,96448,92224,37732,61306,51894,73166,67439,67849,25356,35177,43727,34244,5836,66124,6048,57077,13374,86786,105689,110310,25595,32042,35684,13940,52851,103512,60298,23181,70937,91375,31034,6971,11711,76787,66697,41913,114916,103997,8627,67111,55763,109660,28337,5233,10890,3686,22024,103466,45959,23765,2543,78952,62881,89558,98249,30039,74972,104483,115043,20871,77137,100667,47487,4204,3179,51811,84859};
static const uint64_t omega_1280_inv[1280]={63484,78881,110292,3019,113227,65092,37763,69026,91055,85275,81766,54144,90750,66853,98047,69828,47335,94210,45435,94651,25991,26163,59592,51166,49120,86823,37024,93511,72336,60577,110660,2206,87162,103580,35378,40173,99389,58724,21779,94321,6059,66441,50122,55183,84385,28010,78990,47755,4377,57009,33394,104661,54590,71608,39646,44518,16224,104402,108067,99031,60141,15205,111975,81632,115171,113389,97917,61976,10838,55570,15599,66652,16786,46186,93931,97704,72151,49403,80876,388,395,23858,35571,28790,10901,36335,5815,5623,86187,44690,49653,95976,106021,21533,10342,71692,90800,69873,50053,4935,67672,78394,57837,60365,74815,25987,95042,3527,5669,42885,55832,54464,110078,59214,51375,107824,107394,81422,102487,107602,70945,22641,54225,49562,21359,68953,109686,12497,86653,26756,72369,39530,83592,3153,52200,42453,6699,105097,34844,77040,45176,32927,53414,46658,30279,31716,26350,93927,51382,16086,3906,74641,84598,17835,40425,22449,19588,8065,26322,75,4530,43210,75462,88106,91477,18603,63772,73236,114937,53175,101343,107625,49294,28212,114231,56613,55556,83874,43226,30348,81964,43063,43543,72535,3476,48669,105663,22950,3768,89346,51172,3402,113320,47669,45263,61222,34417,28209,21889,100965,107834,107998,48783,43428,65589,90822,94242,70408,82367,44364,76043,77118,26847,31785,76598,110640,998,37239,106497,4203,419,71388,26358,71370,48311,107080,16376,21422,49718,99902,66669,40853,25260,28091,37802,2261,90484,96867,113757,97104,35911,49326,53185,101947,74986,105436,101400,18907,13013,71739,1478,66231,37438,49396,57413,103876,7176,41747,10137,59310,11093,70972,47312,660,39864,34645,18940,107167,44671,2425,31269,91512,20717,7136,39331,25492,65144,63944,106665,106511,51129,23845,57826,105781,7037,102472,106696,62303,53629,59644,77347,86759,102279,2878,35590,76018,75608,50844,6631,8829,3347,109998,54382,82085,4291,97895,37607,105684,93339,38907,69003,112706,79704,21760,47093,56553,51932,49306,51977,52024,77903,74261,61646,106107,95848,6129,70669,52051,102574,20696,51948,4192,45835,3610,102843,83024,107087,39839,33135,42937,82013,92103,10333,25068,108655,111506,7224,21606,106912,29269,85913,97261,68434,32258,82127,29868,52972,112122,113551,15541,86189,67851,20085,61124,51538,94629,1622,5808,97361,74474,51471,67542,70542,21340,21725,44979,113189,85837,23550,40008,89423,78863,17044,38729,81292,94635,71105,32305,108006,26226,40357,41382,103292,41023,35528,49233,70608,94447,82790,46873,43265,78784,81393,54655,75534,294,63838,31142,60801,55069,31419,100572,107137,42859,100342,93245,102350,76287,22735,105983,42278,111330,42674,89168,63461,100532,104721,58214,106176,30895,22842,20285,73204,89964,65459,82970,57745,31768,52531,16365,66838,97141,61186,78323,99629,73220,44850,59317,34556,82685,40531,97972,65298,4125,18748,72530,3174,7388,77592,101557,51430,111146,100681,44600,44217,44124,61547,54047,61851,3288,60354,5030,73410,56326,15181,64445,90845,72591,75979,27172,51415,110240,92039,75588,49636,71909,11746,87373,70244,26381,49719,53882,51885,23427,55619,64639,33442,84520,36164,41567,114466,70807,37346,20799,35129,94254,94173,20160,65654,94748,54890,89728,97285,763,23045,9506,67278,8516,7482,14149,94273,26200,84867,80163,95564,58096,6888,47392,5492,9154,22977,28439,35781,41474,16688,63307,45150,77437,92195,38930,47352,3076,24509,28811,81290,71474,100673,67157,47288,68331,49077,107266,96731,36422,34110,101827,67738,36300,3701,62259,4891,18934,37684,18174,106981,79517,102626,46877,89587,19648,11689,60890,106525,98055,47271,44264,70003,57905,41432,106312,108230,85836,69570,54792,106849,48504,95697,43089,114234,33754,11204,31596,19102,24791,68884,59438,110985,21836,5603,84979,109968,52570,64801,66267,108733,93177,6082,44790,55693,115189,91436,62207,93911,96496,22228,52320,49701,75835,87595,106693,85162,97981,111922,101471,92316,158,101704,83349,11516,73481,14534,2326,94410,57515,17876,112022,107511,111529,100774,27177,51717,36320,4909,112182,1974,50109,77438,46175,24146,29926,33435,61057,24451,48348,17154,45373,67866,20991,69766,20550,89210,89038,55609,64035,66081,28378,78177,21690,42865,54624,4541,112995,28039,11621,79823,75028,15812,56477,93422,20880,109142,48760,65079,60018,30816,87191,36211,67446,110824,58192,81807,10540,60611,43593,75555,70683,98977,10799,7134,16170,55060,99996,3226,33569,30,1812,17284,53225,104363,59631,99602,48549,98415,69015,21270,17497,43050,65798,34325,114813,114806,91343,79630,86411,104300,78866,109386,109578,29014,70511,65548,19225,9180,93668,104859,43509,24401,45328,65148,110266,47529,36807,57364,54836,40386,89214,20159,111674,109532,72316,59369,60737,5123,55987,63826,7377,7807,33779,12714,7599,44256,92560,60976,65639,93842,46248,5515,102704,28548,88445,42832,75671,31609,112048,63001,72748,108502,10104,80357,38161,70025,82274,61787,68543,84922,83485,88851,21274,63819,99115,111295,40560,30603,97366,74776,92752,95613,107136,88879,115126,110671,71991,39739,27095,23724,96598,51429,41965,264,62026,13858,7576,65907,86989,970,58588,59645,31327,71975,84853,33237,72138,71658,42666,111725,66532,9538,92251,111433,25855,64029,111799,1881,67532,69938,53979,80784,86992,93312,14236,7367,7203,66418,71773,49612,24379,20959,44793,32834,70837,39158,38083,88354,83416,38603,4561,114203,77962,8704,110998,114782,43813,88843,43831,66890,8121,98825,93779,65483,15299,48532,74348,89941,87110,77399,112940,24717,18334,1444,18097,79290,65875,62016,13254,40215,9765,13801,96294,102188,43462,113723,48970,77763,65805,57788,11325,108025,73454,105064,55891,104108,44229,67889,114541,75337,80556,96261,8034,70530,112776,83932,23689,94484,108065,75870,89709,50057,51257,8536,8690,64072,91356,57375,9420,108164,12729,8505,52898,61572,55557,37854,28442,12922,112323,79611,39183,39593,64357,108570,106372,111854,5203,60819,33116,110910,17306,77594,9517,21862,76294,46198,2495,35497,93441,68108,58648,63269,65895,63224,63177,37298,40940,53555,9094,19353,109072,44532,63150,12627,94505,63253,111009,69366,111591,12358,32177,8114,75362,82066,72264,33188,23098,104868,90133,6546,3695,107977,93595,8289,85932,29288,17940,46767,82943,33074,85333,62229,3079,1650,99660,29012,47350,95116,54077,63663,20572,113579,109393,17840,40727,63730,47659,44659,93861,93476,70222,2012,29364,91651,75193,25778,36338,98157,76472,33909,20566,44096,82896,7195,88975,74844,73819,11909,74178,79673,65968,44593,20754,32411,68328,71936,36417,33808,60546,39667,114907,51363,84059,54400,60132,83782,14629,8064,72342,14859,21956,12851,38914,92466,9218,72923,3871,72527,26033,51740,14669,10480,56987,9025,84306,92359,94916,41997,25237,49742,32231,57456,83433,62670,98836,48363,18060,54015,36878,15572,41981,70351,55884,80645,32516,74670,17229,49903,111076,96453,42671,112027,107813,37609,13644,63771,4055,14520,70601,70984,71077,53654,61154,53350,111913,54847,110171,41791,58875,100020,50756,24356,42610,39222,88029,63786,4961,23162,39613,65565,43292,103455,27828,44957,88820,65482,61319,63316,91774,59582,50562,81759,30681,79037,73634,735,44394,77855,94402,80072,20947,21028,95041,49547,20453,60311,25473,17916,114438,92156,105695,47923,106685,107719,101052,20928,89001,30334,35038,19637,57105,108313,67809,109709,106047,92224,86762,79420,73727,98513,51894,70051,37764,23006,76271,67849,112125,90692,86390,33911,43727,14528,48044,67913,46870,66124,7935,18470,78779,81091,13374,47463,78901,111500,52942,110310,96267,77517,97027,8220,35684,12575,68324,25614,95553,103512,54311,8676,17146,67930,70937,45198,57296,73769,8889,6971,29365,45631,60409,8352,66697,19504,72112,967,81447,103997,83605,96099,90410,46317,55763,4216,93365,109598,30222,5233,62631,50400,48934,6468,22024,109119,70411,59508,12,23765,52994,21290,18705,92973,62881,65500,39366,27606,8508,30039,17220,3279,13730,22885,115043,13497,31852,103685,41720,100667,112875,20791,57686,97325,3179,7690,3672,14427,88024};

static const __m256i V_B4Q_B4Q_B4Q_B4Q = {BARRETT_FACTOR_4Q, BARRETT_FACTOR_4Q, BARRETT_FACTOR_4Q, BARRETT_FACTOR_4Q};
static const __m256i V_B8Q_B8Q_B8Q_B8Q = {BARRETT_FACTOR_8Q, BARRETT_FACTOR_8Q, BARRETT_FACTOR_8Q, BARRETT_FACTOR_8Q};
static const __m256i V_B16Q_B16Q_B16Q_B16Q = {BARRETT_FACTOR_16Q, BARRETT_FACTOR_16Q, BARRETT_FACTOR_16Q, BARRETT_FACTOR_16Q};
static const __m256i V_Q_Q_Q_Q = {Q, Q, Q, Q};
static const __m256i V_Q2_Q2_Q2_Q2 = {Q2, Q2, Q2, Q2};
static const __m256i V_MM_MM_MM_MM = {MONTGOMERY_MASK, MONTGOMERY_MASK, MONTGOMERY_MASK, MONTGOMERY_MASK};
static const __m256i V_MF_MF_MF_MF = {MONTGOMERY_FACTOR, MONTGOMERY_FACTOR, MONTGOMERY_FACTOR, MONTGOMERY_FACTOR};

/* bit reverse step of dimension 256 */
static void bit_reverse_256(uint64_t *a)
{
uint64_t t;
t=a[1];a[1]=a[128];a[128]=t;
t=a[2];a[2]=a[64];a[64]=t;
t=a[3];a[3]=a[192];a[192]=t;
t=a[4];a[4]=a[32];a[32]=t;
t=a[5];a[5]=a[160];a[160]=t;
t=a[6];a[6]=a[96];a[96]=t;
t=a[7];a[7]=a[224];a[224]=t;
t=a[8];a[8]=a[16];a[16]=t;
t=a[9];a[9]=a[144];a[144]=t;
t=a[10];a[10]=a[80];a[80]=t;
t=a[11];a[11]=a[208];a[208]=t;
t=a[12];a[12]=a[48];a[48]=t;
t=a[13];a[13]=a[176];a[176]=t;
t=a[14];a[14]=a[112];a[112]=t;
t=a[15];a[15]=a[240];a[240]=t;
t=a[17];a[17]=a[136];a[136]=t;
t=a[18];a[18]=a[72];a[72]=t;
t=a[19];a[19]=a[200];a[200]=t;
t=a[20];a[20]=a[40];a[40]=t;
t=a[21];a[21]=a[168];a[168]=t;
t=a[22];a[22]=a[104];a[104]=t;
t=a[23];a[23]=a[232];a[232]=t;
t=a[25];a[25]=a[152];a[152]=t;
t=a[26];a[26]=a[88];a[88]=t;
t=a[27];a[27]=a[216];a[216]=t;
t=a[28];a[28]=a[56];a[56]=t;
t=a[29];a[29]=a[184];a[184]=t;
t=a[30];a[30]=a[120];a[120]=t;
t=a[31];a[31]=a[248];a[248]=t;
t=a[33];a[33]=a[132];a[132]=t;
t=a[34];a[34]=a[68];a[68]=t;
t=a[35];a[35]=a[196];a[196]=t;
t=a[37];a[37]=a[164];a[164]=t;
t=a[38];a[38]=a[100];a[100]=t;
t=a[39];a[39]=a[228];a[228]=t;
t=a[41];a[41]=a[148];a[148]=t;
t=a[42];a[42]=a[84];a[84]=t;
t=a[43];a[43]=a[212];a[212]=t;
t=a[44];a[44]=a[52];a[52]=t;
t=a[45];a[45]=a[180];a[180]=t;
t=a[46];a[46]=a[116];a[116]=t;
t=a[47];a[47]=a[244];a[244]=t;
t=a[49];a[49]=a[140];a[140]=t;
t=a[50];a[50]=a[76];a[76]=t;
t=a[51];a[51]=a[204];a[204]=t;
t=a[53];a[53]=a[172];a[172]=t;
t=a[54];a[54]=a[108];a[108]=t;
t=a[55];a[55]=a[236];a[236]=t;
t=a[57];a[57]=a[156];a[156]=t;
t=a[58];a[58]=a[92];a[92]=t;
t=a[59];a[59]=a[220];a[220]=t;
t=a[61];a[61]=a[188];a[188]=t;
t=a[62];a[62]=a[124];a[124]=t;
t=a[63];a[63]=a[252];a[252]=t;
t=a[65];a[65]=a[130];a[130]=t;
t=a[67];a[67]=a[194];a[194]=t;
t=a[69];a[69]=a[162];a[162]=t;
t=a[70];a[70]=a[98];a[98]=t;
t=a[71];a[71]=a[226];a[226]=t;
t=a[73];a[73]=a[146];a[146]=t;
t=a[74];a[74]=a[82];a[82]=t;
t=a[75];a[75]=a[210];a[210]=t;
t=a[77];a[77]=a[178];a[178]=t;
t=a[78];a[78]=a[114];a[114]=t;
t=a[79];a[79]=a[242];a[242]=t;
t=a[81];a[81]=a[138];a[138]=t;
t=a[83];a[83]=a[202];a[202]=t;
t=a[85];a[85]=a[170];a[170]=t;
t=a[86];a[86]=a[106];a[106]=t;
t=a[87];a[87]=a[234];a[234]=t;
t=a[89];a[89]=a[154];a[154]=t;
t=a[91];a[91]=a[218];a[218]=t;
t=a[93];a[93]=a[186];a[186]=t;
t=a[94];a[94]=a[122];a[122]=t;
t=a[95];a[95]=a[250];a[250]=t;
t=a[97];a[97]=a[134];a[134]=t;
t=a[99];a[99]=a[198];a[198]=t;
t=a[101];a[101]=a[166];a[166]=t;
t=a[103];a[103]=a[230];a[230]=t;
t=a[105];a[105]=a[150];a[150]=t;
t=a[107];a[107]=a[214];a[214]=t;
t=a[109];a[109]=a[182];a[182]=t;
t=a[110];a[110]=a[118];a[118]=t;
t=a[111];a[111]=a[246];a[246]=t;
t=a[113];a[113]=a[142];a[142]=t;
t=a[115];a[115]=a[206];a[206]=t;
t=a[117];a[117]=a[174];a[174]=t;
t=a[119];a[119]=a[238];a[238]=t;
t=a[121];a[121]=a[158];a[158]=t;
t=a[123];a[123]=a[222];a[222]=t;
t=a[125];a[125]=a[190];a[190]=t;
t=a[127];a[127]=a[254];a[254]=t;
t=a[131];a[131]=a[193];a[193]=t;
t=a[133];a[133]=a[161];a[161]=t;
t=a[135];a[135]=a[225];a[225]=t;
t=a[137];a[137]=a[145];a[145]=t;
t=a[139];a[139]=a[209];a[209]=t;
t=a[141];a[141]=a[177];a[177]=t;
t=a[143];a[143]=a[241];a[241]=t;
t=a[147];a[147]=a[201];a[201]=t;
t=a[149];a[149]=a[169];a[169]=t;
t=a[151];a[151]=a[233];a[233]=t;
t=a[155];a[155]=a[217];a[217]=t;
t=a[157];a[157]=a[185];a[185]=t;
t=a[159];a[159]=a[249];a[249]=t;
t=a[163];a[163]=a[197];a[197]=t;
t=a[167];a[167]=a[229];a[229]=t;
t=a[171];a[171]=a[213];a[213]=t;
t=a[173];a[173]=a[181];a[181]=t;
t=a[175];a[175]=a[245];a[245]=t;
t=a[179];a[179]=a[205];a[205]=t;
t=a[183];a[183]=a[237];a[237]=t;
t=a[187];a[187]=a[221];a[221]=t;
t=a[191];a[191]=a[253];a[253]=t;
t=a[199];a[199]=a[227];a[227]=t;
t=a[203];a[203]=a[211];a[211]=t;
t=a[207];a[207]=a[243];a[243]=t;
t=a[215];a[215]=a[235];a[235]=t;
t=a[223];a[223]=a[251];a[251]=t;
t=a[239];a[239]=a[247];a[247]=t;
}

/* DIF radix-2 NTT */
static void ntt_2(uint64_t *a, uint32_t n, const uint64_t *omega)
{
	uint32_t num_of_problems = 1;
	uint32_t d = n >> 1;
	uint32_t j1, j2, j_omega;
	uint32_t k, j;
	
	__m256i u, v, t, t1, o, u1, v1, r1, r2;

	while (d > 2)
	{
		for (k = 0; k < num_of_problems; k++)
		{
			/* Gentleman-Sande's butterfly
			 * (u, v) <-- (u + v, (u - v) * omega) % Q
			 * where omega = 1 (save 1 multiplication) */
			j1 = 2 * k * d;
			j2 = j1 + d;
			
			j_omega = 0;

			for (j = j1; j < j2; j += 4)
			{
				/* Gentleman-Sande's butterfly
				 * (u, v) <-- (u + v, (u - v) * omega) % Q */
				u = _mm256_loadu_si256((__m256i *)(a + j));
				v = _mm256_loadu_si256((__m256i *)(a + j + d));
				
				t = _mm256_add_epi64(u, v);
				t1 = _mm256_mul_epu32(t, V_B4Q_B4Q_B4Q_B4Q);
				t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_4Q);
				t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
				r1 = _mm256_sub_epi64(t, t1);
				
				t = _mm256_add_epi64(V_Q2_Q2_Q2_Q2, u);
				t = _mm256_sub_epi64(t, v);
				o = _mm256_set_epi64x(omega[j_omega + num_of_problems * 3], omega[j_omega + num_of_problems * 2], omega[j_omega + num_of_problems], omega[j_omega]);
				t = _mm256_mul_epu32(t, o);
				t1 = _mm256_and_si256(t, V_MM_MM_MM_MM);
				t1 = _mm256_mul_epu32(t1, V_MF_MF_MF_MF);
				t1 = _mm256_and_si256(t1, V_MM_MM_MM_MM);
				t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
				t1 = _mm256_add_epi64(t, t1);
				r2 = _mm256_srli_epi64(t1, MONTGOMERY_SHIFT);

				_mm256_storeu_si256((__m256i *)(a + j), r1);
				_mm256_storeu_si256((__m256i *)(a + j + d), r2);

				j_omega += num_of_problems * 4;
			} 
		}
		
		num_of_problems <<= 1;
		d >>= 1;
	}
	
	/* last 2 levels (save some overhead of iterations) */
	for (k = 0; k < num_of_problems; k += 2)
	{
		j = k << 2;
		
		u1 = _mm256_loadu_si256((__m256i *)(a + j));
		v1 = _mm256_loadu_si256((__m256i *)(a + j + 4));
		u = _mm256_permute2f128_si256(u1, v1, 0x20);
		v = _mm256_permute2f128_si256(u1, v1, 0x31);
		
		t = _mm256_add_epi64(u, v);
		t1 = _mm256_mul_epu32(t, V_B4Q_B4Q_B4Q_B4Q);
		t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_4Q);
		t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
		r1 = _mm256_sub_epi64(t, t1);
		
		t = _mm256_add_epi64(V_Q2_Q2_Q2_Q2, u);
		t = _mm256_sub_epi64(t, v);
		o = _mm256_set_epi64x(omega[num_of_problems], omega[0], omega[num_of_problems], omega[0]);
		t = _mm256_mul_epu32(t, o);
		t1 = _mm256_and_si256(t, V_MM_MM_MM_MM);
		t1 = _mm256_mul_epu32(t1, V_MF_MF_MF_MF);
		t1 = _mm256_and_si256(t1, V_MM_MM_MM_MM);
		t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
		t1 = _mm256_add_epi64(t, t1);
		r2 = _mm256_srli_epi64(t1, MONTGOMERY_SHIFT);
		
		u = _mm256_permute2f128_si256(r1, r2, 0x20);
		v = _mm256_permute2f128_si256(r1, r2, 0x31);
		
		_mm256_storeu_si256((__m256i *)(a + j), u);
		_mm256_storeu_si256((__m256i *)(a + j + 4), v);
	}
	
	for (k = 0; k < (n >> 1); k += 4)
	{
		j = k << 1;
		
		u1 = _mm256_loadu_si256((__m256i *)(a + j));
		v1 = _mm256_loadu_si256((__m256i *)(a + j + 4));
		u1 = _mm256_permute4x64_epi64(u1, 0xD8);
		v1 = _mm256_permute4x64_epi64(v1, 0xD8);
		u = _mm256_permute2f128_si256(u1, v1, 0x20);
		v = _mm256_permute2f128_si256(u1, v1, 0x31);
		
		t = _mm256_add_epi64(u, v);
		t1 = _mm256_mul_epu32(t, V_B4Q_B4Q_B4Q_B4Q);
		t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_4Q);
		t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
		r1 = _mm256_sub_epi64(t, t1);

		t = _mm256_add_epi64(V_Q2_Q2_Q2_Q2, u);
		t = _mm256_sub_epi64(t, v);
		t1 = _mm256_mul_epu32(t, V_B4Q_B4Q_B4Q_B4Q);
		t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_4Q);
		t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
		r2 = _mm256_sub_epi64(t, t1);

		u1 = _mm256_permute2f128_si256(r1, r2, 0x20);
		v1 = _mm256_permute2f128_si256(r1, r2, 0x31);
		u = _mm256_permute4x64_epi64(u1, 0xD8);
		v = _mm256_permute4x64_epi64(v1, 0xD8);
		
		_mm256_storeu_si256((__m256i *)(a + j), u);
		_mm256_storeu_si256((__m256i *)(a + j + 4), v);
	}
}

/* Partial NTT similar to Sorensen et al.'s work:
 * Efficient computation of the DFT with only a subset of input or output points
 * X(k1+N1k2)=sum_n2^{N2-1} [omega_N^{n2k1}](sum_n1^{N1-1} x(N2n1+n2)omega_N1^{n1k1})omega_N2^{n2k2}
 * http://ieeexplore.ieee.org/document/205723/
 * 
 * ntt_butterfly is the function of the "partial" subroutine of NTT
 * Note: we exclusively use DIF NTT from natural order input to bit-reversed order output (DIF_N-->DIF_R) for both NTT and Inverse-NTT,
 * because DIF_R-->DIF_N may not be able to be efficiently parallelized due to its non-consecutive memory access at each iteration */
static void ntt_core(uint64_t *a, uint32_t N1, uint32_t N2, const uint64_t *omega_2, const uint64_t *omega_n, void (*ntt_butterfly)(uint64_t *, uint32_t))
{
	uint32_t n1, n2;
	__m256i u, v, t, t1;
	
	/* y_k1(n2)=sum_n1^{N1-1} x(N2n1+n2)omega_N1^{n1k1} */
	for (n2 = 0; n2 < N2; n2 += 4)
	{
		ntt_butterfly(a, n2);
	}
	
	/* multiply each a coordinate by corresponding twiddle factors 
	 * we don't need to multiply with those twiddle factors which is equal to 1 */
	for (n1 = 1; n1 < N1; n1++)
	{
		for (n2 = 0; n2 < N2; n2 += 4)
		{
			u = _mm256_loadu_si256((__m256i *)(a + N2 * n1 + n2));
			v = _mm256_set_epi64x(omega_n[n1 * (n2 + 3)], omega_n[n1 * (n2 + 2)], omega_n[n1 * (n2 + 1)], omega_n[n1 * n2]);
			
			t = _mm256_mul_epu32(u, v);
			t1 = _mm256_and_si256(t, V_MM_MM_MM_MM);
			t1 = _mm256_mul_epu32(t1, V_MF_MF_MF_MF);
			t1 = _mm256_and_si256(t1, V_MM_MM_MM_MM);
			t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
			t1 = _mm256_add_epi64(t, t1);
			u = _mm256_srli_epi64(t1, MONTGOMERY_SHIFT);
			
			_mm256_storeu_si256((__m256i *)(a + N2 * n1 + n2), u);
		}
	}
	
    /* sum_n2^{N2-1} [omega_N^{n2k1}]y_k1(n2)omega_N2^{n2k2} */
	for (n1 = 0; n1 < N1; n1++)
	{
		ntt_2(a + N2 * n1, N2, omega_2);
		bit_reverse_256(a + N2 * n1);
	}
}

/* Inverse-NTT, which is the NTT in "reversed order" of each step 
 * X(k2+N2k1)=sum_n1^{N1-1} [omega_N^{-n1k2}](sum_n2^{N2-1} x(N1n2+n1)omega_N2^{-n2k2})omega_N1^{-n1k1} */
static void intt_core(uint64_t *a, uint32_t N1, uint32_t N2, uint32_t DIM, const uint64_t *omega_2, const uint64_t *omega_n, void (*ntt_butterfly)(uint64_t *, uint32_t), uint64_t inv_n)
{
	uint32_t i, n1, n2;
	__m256i u, v, t, t1;
	
	for (n1 = 0; n1 < N1; n1++)
	{
		ntt_2(a + N2 * n1, N2, omega_2);
		bit_reverse_256(a + N2 * n1);
	}
	
	for (n1 = 1; n1 < N1; n1++)
	{
		for (n2 = 0; n2 < N2; n2 += 4)
		{
			u = _mm256_loadu_si256((__m256i *)(a + N2 * n1 + n2));
			v = _mm256_set_epi64x(omega_n[n1 * (n2 + 3)], omega_n[n1 * (n2 + 2)], omega_n[n1 * (n2 + 1)], omega_n[n1 * n2]);
			
			t = _mm256_mul_epu32(u, v);
			t1 = _mm256_and_si256(t, V_MM_MM_MM_MM);
			t1 = _mm256_mul_epu32(t1, V_MF_MF_MF_MF);
			t1 = _mm256_and_si256(t1, V_MM_MM_MM_MM);
			t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
			t1 = _mm256_add_epi64(t, t1);
			u = _mm256_srli_epi64(t1, MONTGOMERY_SHIFT);
			
			_mm256_storeu_si256((__m256i *)(a + N2 * n1 + n2), u);
		}
	}
	
	for (n2 = 0; n2 < N2; n2 += 4)
	{
		ntt_butterfly(a, n2);
	}
	
	/* multiply each a coordinate by the multiplication inverse of the dimension n */
	for (i = 0; i < DIM; i += 4)
	{
		u = _mm256_loadu_si256((__m256i *)(a + i));
		v = _mm256_set1_epi64x(inv_n);
		
		t = _mm256_mul_epu32(u, v);
		t1 = _mm256_and_si256(t, V_MM_MM_MM_MM);
		t1 = _mm256_mul_epu32(t1, V_MF_MF_MF_MF);
		t1 = _mm256_and_si256(t1, V_MM_MM_MM_MM);
		t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
		t1 = _mm256_add_epi64(t, t1);
		u = _mm256_srli_epi64(t1, MONTGOMERY_SHIFT);
			
		_mm256_storeu_si256((__m256i *)(a + i), u);
	}
}

/* 256 * 4 --> 256 * 6 */
static void ntt_butterfly_1024_1536(uint64_t *a, uint32_t n2)
{
	__m256i b, c, d, e, c1, d1, e1, t, t1;
	
	b = _mm256_loadu_si256((__m256i *)(a + n2));	
	c = _mm256_loadu_si256((__m256i *)(a + N2_1536 + n2));	
	d = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 2 + n2));	
	e = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 3 + n2));	

	t = _mm256_add_epi64(b, c);
	t = _mm256_add_epi64(t, d);
	t = _mm256_add_epi64(t, e);
	t1 = _mm256_mul_epu32(t, V_B8Q_B8Q_B8Q_B8Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_8Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);
	_mm256_storeu_si256((__m256i *)(a + n2), t);
	
	c1 = _mm256_mul_epu32(c, w_6[0][0]);
	d1 = _mm256_mul_epu32(d, w_6[0][1]);
	e1 = _mm256_mul_epu32(e, w_6[0][2]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 + n2), t);
	a[N2_1536 + n2] %= Q;
	a[N2_1536 + n2 + 1] %= Q;
	a[N2_1536 + n2 + 2] %= Q;
	a[N2_1536 + n2 + 3] %= Q;
	
	c1 = _mm256_mul_epu32(c, w_6[1][0]);
	d1 = _mm256_mul_epu32(d, w_6[1][1]);
	e1 = _mm256_mul_epu32(e, w_6[1][2]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 * 2 + n2), t);
	a[N2_1536 * 2 + n2] %= Q;
	a[N2_1536 * 2 + n2 + 1] %= Q;
	a[N2_1536 * 2 + n2 + 2] %= Q;
	a[N2_1536 * 2 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_6[2][0]);
	d1 = _mm256_mul_epu32(d, w_6[2][1]);
	e1 = _mm256_mul_epu32(e, w_6[2][2]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 * 3 + n2), t);
	a[N2_1536 * 3 + n2] %= Q;
	a[N2_1536 * 3 + n2 + 1] %= Q;
	a[N2_1536 * 3 + n2 + 2] %= Q;
	a[N2_1536 * 3 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_6[3][0]);
	d1 = _mm256_mul_epu32(d, w_6[3][1]);
	e1 = _mm256_mul_epu32(e, w_6[3][2]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 * 4 + n2), t);
	a[N2_1536 * 4 + n2] %= Q;
	a[N2_1536 * 4 + n2 + 1] %= Q;
	a[N2_1536 * 4 + n2 + 2] %= Q;
	a[N2_1536 * 4 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_6[4][0]);
	d1 = _mm256_mul_epu32(d, w_6[4][1]);
	e1 = _mm256_mul_epu32(e, w_6[4][2]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 * 5 + n2), t);
	a[N2_1536 * 5 + n2] %= Q;
	a[N2_1536 * 5 + n2 + 1] %= Q;
	a[N2_1536 * 5 + n2 + 2] %= Q;
	a[N2_1536 * 5 + n2 + 3] %= Q;
}

/* 256 * 6 --> 256 * 3 */
static void ntt_butterfly_1536_768(uint64_t *a, uint32_t n2)
{
	__m256i b, c, d, e, f, g, c1, d1, e1, f1, g1, t, t1;
	
	b = _mm256_loadu_si256((__m256i *)(a + n2));	
	c = _mm256_loadu_si256((__m256i *)(a + N2_1536 + n2));	
	d = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 2 + n2));	
	e = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 3 + n2));	
	f = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 4 + n2));	
	g = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 5 + n2));	
	
	t = _mm256_add_epi64(b, c);
	t = _mm256_add_epi64(t, d);
	t = _mm256_add_epi64(t, e);
	t = _mm256_add_epi64(t, f);
	t = _mm256_add_epi64(t, g);
	t1 = _mm256_mul_epu32(t, V_B16Q_B16Q_B16Q_B16Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_16Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);	
	_mm256_storeu_si256((__m256i *)(a + n2), t);
	
	c1 = _mm256_mul_epu32(c, w_6[0][0]);
	d1 = _mm256_mul_epu32(d, w_6[0][1]);
	e1 = _mm256_mul_epu32(e, w_6[0][2]);
	f1 = _mm256_mul_epu32(f, w_6[0][3]);
	g1 = _mm256_mul_epu32(g, w_6[0][4]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	t = _mm256_add_epi64(t, g1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 + n2), t);
	a[N2_1536 + n2] %= Q;
	a[N2_1536 + n2 + 1] %= Q;
	a[N2_1536 + n2 + 2] %= Q;
	a[N2_1536 + n2 + 3] %= Q;
	
	c1 = _mm256_mul_epu32(c, w_6[1][0]);
	d1 = _mm256_mul_epu32(d, w_6[1][1]);
	e1 = _mm256_mul_epu32(e, w_6[1][2]);
	f1 = _mm256_mul_epu32(f, w_6[1][3]);
	g1 = _mm256_mul_epu32(g, w_6[1][4]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	t = _mm256_add_epi64(t, g1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 * 2 + n2), t);
	a[N2_1536 * 2 + n2] %= Q;
	a[N2_1536 * 2 + n2 + 1] %= Q;
	a[N2_1536 * 2 + n2 + 2] %= Q;
	a[N2_1536 * 2 + n2 + 3] %= Q;
}

/* 256 * 2 --> 256 * 5 */
static void ntt_butterfly_512_1280(uint64_t *a, uint32_t n2)
{
	__m256i b, c, c1, t, t1;
	
	b = _mm256_loadu_si256((__m256i *)(a + n2));
	c = _mm256_loadu_si256((__m256i *)(a + N2_1280 + n2));
	
	t = _mm256_add_epi64(b, c);
	t1 = _mm256_mul_epu32(t, V_B4Q_B4Q_B4Q_B4Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_4Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);	
	_mm256_storeu_si256((__m256i *)(a + n2), t);

	c1 = _mm256_mul_epu32(c, w_5[0][0]);
	t = _mm256_add_epi64(b, c1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 + n2), t);
	a[N2_1280 + n2] %= Q;
	a[N2_1280 + n2 + 1] %= Q;
	a[N2_1280 + n2 + 2] %= Q;
	a[N2_1280 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_5[1][0]);
	t = _mm256_add_epi64(b, c1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 * 2 + n2), t);
	a[N2_1280 * 2 + n2] %= Q;
	a[N2_1280 * 2 + n2 + 1] %= Q;
	a[N2_1280 * 2 + n2 + 2] %= Q;
	a[N2_1280 * 2 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_5[2][0]);
	t = _mm256_add_epi64(b, c1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 * 3 + n2), t);
	a[N2_1280 * 3 + n2] %= Q;
	a[N2_1280 * 3 + n2 + 1] %= Q;
	a[N2_1280 * 3 + n2 + 2] %= Q;
	a[N2_1280 * 3 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_5[3][0]);
	t = _mm256_add_epi64(b, c1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 * 4 + n2), t);
	a[N2_1280 * 4 + n2] %= Q;
	a[N2_1280 * 4 + n2 + 1] %= Q;
	a[N2_1280 * 4 + n2 + 2] %= Q;
	a[N2_1280 * 4 + n2 + 3] %= Q;
}

/* 256 * 4 --> 256 * 5 */
static void ntt_butterfly_1024_1280(uint64_t *a, uint32_t n2)
{
	__m256i b, c, d, e, c1, d1, e1, t, t1;
	
	b = _mm256_loadu_si256((__m256i *)(a + n2));
	c = _mm256_loadu_si256((__m256i *)(a + N2_1280 + n2));
	d = _mm256_loadu_si256((__m256i *)(a + N2_1280 * 2 + n2));
	e = _mm256_loadu_si256((__m256i *)(a + N2_1280 * 3 + n2));

	t = _mm256_add_epi64(b, c);
	t = _mm256_add_epi64(t, d);
	t = _mm256_add_epi64(t, e);
	t1 = _mm256_mul_epu32(t, V_B8Q_B8Q_B8Q_B8Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_8Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);	
	_mm256_storeu_si256((__m256i *)(a + n2), t);

	c1 = _mm256_mul_epu32(c, w_5[0][0]);
	d1 = _mm256_mul_epu32(d, w_5[0][1]);
	e1 = _mm256_mul_epu32(e, w_5[0][2]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 + n2), t);
	a[N2_1280 + n2] %= Q;
	a[N2_1280 + n2 + 1] %= Q;
	a[N2_1280 + n2 + 2] %= Q;
	a[N2_1280 + n2 + 3] %= Q;
	
	c1 = _mm256_mul_epu32(c, w_5[1][0]);
	d1 = _mm256_mul_epu32(d, w_5[1][1]);
	e1 = _mm256_mul_epu32(e, w_5[1][2]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 * 2 + n2), t);
	a[N2_1280 * 2 + n2] %= Q;
	a[N2_1280 * 2 + n2 + 1] %= Q;
	a[N2_1280 * 2 + n2 + 2] %= Q;
	a[N2_1280 * 2 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_5[2][0]);
	d1 = _mm256_mul_epu32(d, w_5[2][1]);
	e1 = _mm256_mul_epu32(e, w_5[2][2]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 * 3 + n2), t);
	a[N2_1280 * 3 + n2] %= Q;
	a[N2_1280 * 3 + n2 + 1] %= Q;
	a[N2_1280 * 3 + n2 + 2] %= Q;
	a[N2_1280 * 3 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_5[3][0]);
	d1 = _mm256_mul_epu32(d, w_5[3][1]);
	e1 = _mm256_mul_epu32(e, w_5[3][2]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 * 4 + n2), t);
	a[N2_1280 * 4 + n2] %= Q;
	a[N2_1280 * 4 + n2 + 1] %= Q;
	a[N2_1280 * 4 + n2 + 2] %= Q;
	a[N2_1280 * 4 + n2 + 3] %= Q;
}

/* 256 * 5 --> 256 * 5 */
static void ntt_butterfly_1280_1280_inv(uint64_t *a, uint32_t n2)
{
	__m256i b, c, d, e, f, c1, d1, e1, f1, t, t1;

	b = _mm256_loadu_si256((__m256i *)(a + n2));
	c = _mm256_loadu_si256((__m256i *)(a + N2_1280 + n2));
	d = _mm256_loadu_si256((__m256i *)(a + N2_1280 * 2 + n2));
	e = _mm256_loadu_si256((__m256i *)(a + N2_1280 * 3 + n2));
	f = _mm256_loadu_si256((__m256i *)(a + N2_1280 * 4 + n2));

	t = _mm256_add_epi64(b, c);
	t = _mm256_add_epi64(t, d);
	t = _mm256_add_epi64(t, e);
	t = _mm256_add_epi64(t, f);
	t1 = _mm256_mul_epu32(t, V_B16Q_B16Q_B16Q_B16Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_16Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);	
	_mm256_storeu_si256((__m256i *)(a + n2), t);

	c1 = _mm256_mul_epu32(c, w_5_inv[0][0]);
	d1 = _mm256_mul_epu32(d, w_5_inv[0][1]);
	e1 = _mm256_mul_epu32(e, w_5_inv[0][2]);
	f1 = _mm256_mul_epu32(f, w_5_inv[0][3]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 + n2), t);
	a[N2_1280 + n2] %= Q;
	a[N2_1280 + n2 + 1] %= Q;
	a[N2_1280 + n2 + 2] %= Q;
	a[N2_1280 + n2 + 3] %= Q;
	
	c1 = _mm256_mul_epu32(c, w_5_inv[1][0]);
	d1 = _mm256_mul_epu32(d, w_5_inv[1][1]);
	e1 = _mm256_mul_epu32(e, w_5_inv[1][2]);
	f1 = _mm256_mul_epu32(f, w_5_inv[1][3]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 * 2 + n2), t);
	a[N2_1280 * 2 + n2] %= Q;
	a[N2_1280 * 2 + n2 + 1] %= Q;
	a[N2_1280 * 2 + n2 + 2] %= Q;
	a[N2_1280 * 2 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_5_inv[2][0]);
	d1 = _mm256_mul_epu32(d, w_5_inv[2][1]);
	e1 = _mm256_mul_epu32(e, w_5_inv[2][2]);
	f1 = _mm256_mul_epu32(f, w_5_inv[2][3]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 * 3 + n2), t);
	a[N2_1280 * 3 + n2] %= Q;
	a[N2_1280 * 3 + n2 + 1] %= Q;
	a[N2_1280 * 3 + n2 + 2] %= Q;
	a[N2_1280 * 3 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_5_inv[3][0]);
	d1 = _mm256_mul_epu32(d, w_5_inv[3][1]);
	e1 = _mm256_mul_epu32(e, w_5_inv[3][2]);
	f1 = _mm256_mul_epu32(f, w_5_inv[3][3]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	_mm256_storeu_si256((__m256i *)(a + N2_1280 * 4 + n2), t);
	a[N2_1280 * 4 + n2] %= Q;
	a[N2_1280 * 4 + n2 + 1] %= Q;
	a[N2_1280 * 4 + n2 + 2] %= Q;
	a[N2_1280 * 4 + n2 + 3] %= Q;
}

/* 256 * 3 --> 256 * 3 */
static void ntt_butterfly_768_768_inv(uint64_t *a, uint32_t n2)
{
	__m256i b, c, d, c1, d1, t, t1;

	b = _mm256_loadu_si256((__m256i *)(a + n2));
	c = _mm256_loadu_si256((__m256i *)(a + N2_768 + n2));
	d = _mm256_loadu_si256((__m256i *)(a + N2_768 * 2 + n2));
	
	t = _mm256_add_epi64(b, c);
	t = _mm256_add_epi64(t, d);
	t1 = _mm256_mul_epu32(t, V_B8Q_B8Q_B8Q_B8Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_8Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);	
	_mm256_storeu_si256((__m256i *)(a + n2), t);

	c1 = _mm256_mul_epu32(c, w_3_inv[0]);
	d1 = _mm256_mul_epu32(d, w_3_inv[1]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	_mm256_storeu_si256((__m256i *)(a + N2_768 + n2), t);
	a[N2_768 + n2] %= Q;
	a[N2_768 + n2 + 1] %= Q;
	a[N2_768 + n2 + 2] %= Q;
	a[N2_768 + n2 + 3] %= Q;
	
	c1 = _mm256_mul_epu32(c, w_3_inv[1]);
	d1 = _mm256_mul_epu32(d, w_3_inv[0]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	_mm256_storeu_si256((__m256i *)(a + N2_768 * 2 + n2), t);
	a[N2_768 * 2 + n2] %= Q;
	a[N2_768 * 2 + n2 + 1] %= Q;
	a[N2_768 * 2 + n2 + 2] %= Q;
	a[N2_768 * 2 + n2 + 3] %= Q;
}

/* 256 * 2 --> 256 * 3 */
static void ntt_butterfly_512_768(uint64_t *a, uint32_t n2)
{
	__m256i b, c, c1, t, t1;

	b = _mm256_loadu_si256((__m256i *)(a + n2));
	c = _mm256_loadu_si256((__m256i *)(a + N2_768 + n2));
	
	t = _mm256_add_epi64(b, c);
	t1 = _mm256_mul_epu32(t, V_B4Q_B4Q_B4Q_B4Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_4Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);	
	_mm256_storeu_si256((__m256i *)(a + n2), t);

	c1 = _mm256_mul_epu32(c, w_3[0]);
	t = _mm256_add_epi64(b, c1);
	_mm256_storeu_si256((__m256i *)(a + N2_768 + n2), t);
	a[N2_768 + n2] %= Q;
	a[N2_768 + n2 + 1] %= Q;
	a[N2_768 + n2 + 2] %= Q;
	a[N2_768 + n2 + 3] %= Q;
	
	c1 = _mm256_mul_epu32(c, w_3[1]);
	t = _mm256_add_epi64(b, c1);
	_mm256_storeu_si256((__m256i *)(a + N2_768 * 2 + n2), t);
	a[N2_768 * 2 + n2] %= Q;
	a[N2_768 * 2 + n2 + 1] %= Q;
	a[N2_768 * 2 + n2 + 2] %= Q;
	a[N2_768 * 2 + n2 + 3] %= Q;	
}

/* 256 * 3 --> 256 * 1 */
static void ntt_butterfly_768_256(uint64_t *a, uint32_t n2)
{
	__m256i b, c, d, t, t1;

	b = _mm256_loadu_si256((__m256i *)(a + n2));
	c = _mm256_loadu_si256((__m256i *)(a + N2_768 + n2));
	d = _mm256_loadu_si256((__m256i *)(a + N2_768 * 2 + n2));
	
	t = _mm256_add_epi64(b, c);
	t = _mm256_add_epi64(t, d);
	t1 = _mm256_mul_epu32(t, V_B8Q_B8Q_B8Q_B8Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_8Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);	
	_mm256_storeu_si256((__m256i *)(a + n2), t);
}

/* 256 * 5 --> 256 * 6 */
static void ntt_butterfly_1280_1536(uint64_t *a, uint32_t n2)
{
	__m256i b, c, d, e, f, c1, d1, e1, f1, t, t1;

	b = _mm256_loadu_si256((__m256i *)(a + n2));	
	c = _mm256_loadu_si256((__m256i *)(a + N2_1536 + n2));	
	d = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 2 + n2));	
	e = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 3 + n2));	
	f = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 4 + n2));	
	
	t = _mm256_add_epi64(b, c);
	t = _mm256_add_epi64(t, d);
	t = _mm256_add_epi64(t, e);
	t = _mm256_add_epi64(t, f);
	t1 = _mm256_mul_epu32(t, V_B16Q_B16Q_B16Q_B16Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_16Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);	
	_mm256_storeu_si256((__m256i *)(a + n2), t);
	
	c1 = _mm256_mul_epu32(c, w_6[0][0]);
	d1 = _mm256_mul_epu32(d, w_6[0][1]);
	e1 = _mm256_mul_epu32(e, w_6[0][2]);
	f1 = _mm256_mul_epu32(f, w_6[0][3]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 + n2), t);
	a[N2_1536 + n2] %= Q;
	a[N2_1536 + n2 + 1] %= Q;
	a[N2_1536 + n2 + 2] %= Q;
	a[N2_1536 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_6[1][0]);
	d1 = _mm256_mul_epu32(d, w_6[1][1]);
	e1 = _mm256_mul_epu32(e, w_6[1][2]);
	f1 = _mm256_mul_epu32(f, w_6[1][3]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 * 2 + n2), t);
	a[N2_1536 * 2 + n2] %= Q;
	a[N2_1536 * 2 + n2 + 1] %= Q;
	a[N2_1536 * 2 + n2 + 2] %= Q;
	a[N2_1536 * 2 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_6[2][0]);
	d1 = _mm256_mul_epu32(d, w_6[2][1]);
	e1 = _mm256_mul_epu32(e, w_6[2][2]);
	f1 = _mm256_mul_epu32(f, w_6[2][3]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 * 3 + n2), t);
	a[N2_1536 * 3 + n2] %= Q;
	a[N2_1536 * 3 + n2 + 1] %= Q;
	a[N2_1536 * 3 + n2 + 2] %= Q;
	a[N2_1536 * 3 + n2 + 3] %= Q;

	c1 = _mm256_mul_epu32(c, w_6[3][0]);
	d1 = _mm256_mul_epu32(d, w_6[3][1]);
	e1 = _mm256_mul_epu32(e, w_6[3][2]);
	f1 = _mm256_mul_epu32(f, w_6[3][3]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 * 4 + n2), t);
	a[N2_1536 * 4 + n2] %= Q;
	a[N2_1536 * 4 + n2 + 1] %= Q;
	a[N2_1536 * 4 + n2 + 2] %= Q;
	a[N2_1536 * 4 + n2 + 3] %= Q;
	
	c1 = _mm256_mul_epu32(c, w_6[4][0]);
	d1 = _mm256_mul_epu32(d, w_6[4][1]);
	e1 = _mm256_mul_epu32(e, w_6[4][2]);
	f1 = _mm256_mul_epu32(f, w_6[4][3]);
	t = _mm256_add_epi64(b, c1);
	t = _mm256_add_epi64(t, d1);
	t = _mm256_add_epi64(t, e1);
	t = _mm256_add_epi64(t, f1);
	_mm256_storeu_si256((__m256i *)(a + N2_1536 * 5 + n2), t);
	a[N2_1536 * 5 + n2] %= Q;
	a[N2_1536 * 5 + n2 + 1] %= Q;
	a[N2_1536 * 5 + n2 + 2] %= Q;
	a[N2_1536 * 5 + n2 + 3] %= Q;
}

/* 256 * 6 --> 256 * 1 */
static void ntt_butterfly_1536_256(uint64_t *a, uint32_t n2)
{
	__m256i b, c, d, e, f, g, t, t1;
	
	b = _mm256_loadu_si256((__m256i *)(a + n2));	
	c = _mm256_loadu_si256((__m256i *)(a + N2_1536 + n2));	
	d = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 2 + n2));	
	e = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 3 + n2));	
	f = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 4 + n2));	
	g = _mm256_loadu_si256((__m256i *)(a + N2_1536 * 5 + n2));	
	
	t = _mm256_add_epi64(b, c);
	t = _mm256_add_epi64(t, d);
	t = _mm256_add_epi64(t, e);
	t = _mm256_add_epi64(t, f);
	t = _mm256_add_epi64(t, g);
	t1 = _mm256_mul_epu32(t, V_B16Q_B16Q_B16Q_B16Q);
	t1 = _mm256_srli_epi64(t1, BARRETT_BITSHIFT_16Q);
	t1 = _mm256_mul_epu32(t1, V_Q_Q_Q_Q);
	t = _mm256_sub_epi64(t, t1);	
	_mm256_storeu_si256((__m256i *)(a + n2), t);
}

void ntt_1024_1536(uint64_t *a)
{
	ntt_core(a, N1_1536, N2_1536, omega_256, omega_1536, ntt_butterfly_1024_1536);
}

void intt_1536_768(uint64_t *a)
{
	intt_core(a, N1_1536, N2_1536, 768, omega_256, omega_1536, ntt_butterfly_1536_768, INV_1536);
}

void ntt_512_1280(uint64_t *a)
{
	ntt_core(a, N1_1280, N2_1280, omega_256, omega_1280, ntt_butterfly_512_1280);
}

void ntt_1024_1280(uint64_t *a)
{
	ntt_core(a, N1_1280, N2_1280, omega_256, omega_1280, ntt_butterfly_1024_1280);
}

void intt_1280_1280_inv(uint64_t *a)
{
	intt_core(a, N1_1280, N2_1280, 1280, omega_256_inv, omega_1280_inv, ntt_butterfly_1280_1280_inv, INV_1280);
}

void ntt_768_768_inv(uint64_t *a)
{
	ntt_core(a, N1_768, N2_768, omega_256_inv, omega_768_inv, ntt_butterfly_768_768_inv);
}

void ntt_512_768(uint64_t *a)
{
	ntt_core(a, N1_768, N2_768, omega_256, omega_768, ntt_butterfly_512_768);
}

void intt_768_256(uint64_t *a)
{
	intt_core(a, N1_768, N2_768, 256, omega_256, omega_768, ntt_butterfly_768_256, INV_768);
}

void ntt_1280_1536(uint64_t *a)
{
	ntt_core(a, N1_1536, N2_1536, omega_256, omega_1536, ntt_butterfly_1280_1536);
}

void intt_1536_256(uint64_t *a)
{
	intt_core(a, N1_1536, N2_1536, 256, omega_256, omega_1536, ntt_butterfly_1536_256, INV_1536);
}
