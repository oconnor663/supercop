#include "inttypes.h"
#include <immintrin.h>
#include "ntt.h"
#include "params.h"
#include "reduce.h"

/*************************************************
* Name:        ntt
*
* Description: Computes number-theoretic transform (NTT) of
*              a polynomial in place; inputs assumed to be in
*              normal order, output in bitreversed order
*
* Arguments:   - int16_t * a:           pointer to in/output polynomial
*              - const int16_t* gammas: pointer to input powers of root of unity gamma;
*                                       assumed to be in Montgomery domain
**************************************************/

#define V ((1U << 26)/NEWHOPECMPCT_Q + 1)
const uint16_t _16xq[16]  __attribute__((aligned(32))) = {NEWHOPECMPCT_Q, NEWHOPECMPCT_Q, NEWHOPECMPCT_Q, NEWHOPECMPCT_Q, NEWHOPECMPCT_Q, NEWHOPECMPCT_Q, NEWHOPECMPCT_Q, NEWHOPECMPCT_Q, NEWHOPECMPCT_Q, NEWHOPECMPCT_Q, NEWHOPECMPCT_Q, NEWHOPECMPCT_Q, NEWHOPECMPCT_Q, NEWHOPECMPCT_Q, NEWHOPECMPCT_Q, NEWHOPECMPCT_Q};
const uint16_t _16xv[16] __attribute__((aligned(32))) = {V, V, V, V, V, V, V, V, V, V, V, V, V, V, V, V};
const uint16_t _16xqinv[16]  __attribute__((aligned(32))) = {NEWHOPECMPCT_QINV, NEWHOPECMPCT_QINV, NEWHOPECMPCT_QINV, NEWHOPECMPCT_QINV, NEWHOPECMPCT_QINV, NEWHOPECMPCT_QINV, NEWHOPECMPCT_QINV, NEWHOPECMPCT_QINV, NEWHOPECMPCT_QINV, NEWHOPECMPCT_QINV, NEWHOPECMPCT_QINV, NEWHOPECMPCT_QINV, NEWHOPECMPCT_QINV, NEWHOPECMPCT_QINV, NEWHOPECMPCT_QINV, NEWHOPECMPCT_QINV};
void ntt_avx(int16_t*, const uint16_t *);
void invntt_avx(int16_t*, const uint16_t *);
#if (NEWHOPECMPCT_N == 512 || NEWHOPECMPCT_N == 1024)
const uint16_t zetas_exp[396] = {
31499, 31499, 2571, 2571, 
14746, 14746, 2970, 2970, 
13525, 13525, 13525, 13525, 13525, 13525, 13525, 13525, 53134, 53134, 53134, 53134, 53134, 53134, 53134, 53134, 
1493, 1493, 1493, 1493, 1493, 1493, 1493, 1493, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 1422, 
44630, 44630, 44630, 44630, 27758, 27758, 27758, 27758, 61737, 61737, 61737, 61737, 49846, 49846, 49846, 49846, 
3158, 3158, 3158, 3158, 622, 622, 622, 622, 1577, 1577, 1577, 1577, 182, 182, 182, 182, 
59709, 59709, 17364, 17364, 39176, 39176, 36479, 36479, 5572, 5572, 64434, 64434, 21439, 21439, 39295, 39295, 
573, 573, 2004, 2004, 264, 264, 383, 383, 2500, 2500, 1458, 1458, 1727, 1727, 3199, 3199, 
59847, 59020, 1497, 30967, 41972, 20179, 20711, 25081, 52740, 26617, 16065, 53095, 9135, 64887, 39550, 27837, 
1223, 652, 2777, 1015, 2036, 1491, 3047, 1785, 516, 3321, 3009, 2663, 1711, 2167, 126, 1469, 
65202, 54059, 33310, 20494, 37798, 945, 50654, 6182, 32011, 10631, 29176, 36775, 47051, 17561, 51106, 60261, 
2226, 555, 2078, 1550, 422, 177, 3038, 1574, 3083, 1159, 2552, 2727, 1739, 2457, 418, 3173, 
11182, 13387, 51303, 43881, 13131, 60950, 23093, 5493, 33034, 30318, 46795, 12639, 20100, 18525, 19529, 52918, 
430, 843, 871, 105, 587, 3094, 2869, 1653, 778, 3182, 1483, 1119, 644, 349, 329, 3254, 
788, 788, 1812, 1812, 
28191, 28191, 28191, 28191, 28191, 28191, 28191, 28191, 48842, 48842, 48842, 48842, 48842, 48842, 48842, 48842, 
287, 287, 287, 287, 287, 287, 287, 287, 202, 202, 202, 202, 202, 202, 202, 202, 
10690, 10690, 10690, 10690, 1359, 1359, 1359, 1359, 54335, 54335, 54335, 54335, 31164, 31164, 31164, 31164, 
962, 962, 962, 962, 2127, 2127, 2127, 2127, 1855, 1855, 1855, 1855, 1468, 1468, 1468, 1468, 
37464, 37464, 24313, 24313, 55004, 55004, 8800, 8800, 18427, 18427, 8859, 8859, 26676, 26676, 49374, 49374, 
2648, 2648, 1017, 1017, 732, 732, 608, 608, 1787, 1787, 411, 411, 3124, 3124, 1758, 1758, 
19884, 37287, 49650, 56638, 37227, 9076, 35338, 18250, 13427, 14017, 36381, 52780, 16832, 4312, 41381, 47622, 
2476, 3239, 3058, 830, 107, 1908, 3082, 2378, 2931, 961, 1821, 2604, 448, 2264, 677, 2054, 
34353, 25435, 58154, 24392, 44610, 10946, 24215, 16990, 10336, 57603, 43035, 10907, 31637, 28644, 23998, 48114, 
817, 603, 1322, 1864, 2114, 1218, 2455, 2142, 2144, 2051, 1819, 2459, 3221, 996, 958, 1522, 
20297, 2146, 15356, 33152, 59257, 50634, 54492, 14470, 44039, 45338, 23211, 48094, 41677, 45279, 7757, 23132, 
1097, 610, 2044, 384, 3193, 1994, 220, 1670, 1799, 794, 2475, 478, 3021, 991, 1869, 1628, 
};
 
const uint16_t zetas_inv_exp[400] = {
42405, 57780, 20258, 23860, 17443, 42326, 20199, 21498, 51067, 11045, 14903, 6280, 32385, 50181, 63391, 45240, 
1701, 1460, 2338, 308, 2851, 854, 2535, 1530, 1659, 3109, 1335, 136, 2945, 1285, 2719, 2232, 
12619, 46008, 47012, 45437, 52898, 18742, 35219, 32503, 60044, 42444, 4587, 52406, 21656, 14234, 52150, 54355, 
75, 3000, 2980, 2685, 2210, 1846, 147, 2551, 1676, 460, 235, 2742, 3224, 2458, 2486, 2899, 
17423, 41539, 36893, 33900, 54630, 22502, 7934, 55201, 48547, 41322, 54591, 20927, 41145, 7383, 40102, 31184, 
1807, 2371, 2333, 108, 870, 1510, 1278, 1185, 1187, 874, 2111, 1215, 1465, 2007, 2726, 2512, 
5276, 14431, 47976, 18486, 28762, 36361, 54906, 33526, 59355, 14883, 64592, 27739, 45043, 32227, 11478, 335, 
156, 2911, 872, 1590, 602, 777, 2170, 246, 1755, 291, 3152, 2907, 1779, 1251, 2774, 1103, 
17915, 24156, 61225, 48705, 12757, 29156, 51520, 52110, 47287, 30199, 56461, 28310, 8899, 15887, 28250, 45653, 
1275, 2652, 1065, 2881, 725, 1508, 2368, 398, 951, 247, 1421, 3222, 2499, 271, 90, 853, 
37700, 25987, 650, 56402, 12442, 49472, 38920, 12797, 40456, 44826, 45358, 23565, 34570, 64040, 6517, 5690, 
1860, 3203, 1162, 1618, 666, 320, 8, 2813, 1544, 282, 1838, 1293, 2314, 552, 2677, 2106, 
16163, 16163, 38861, 38861, 56678, 56678, 47110, 47110, 56737, 56737, 10533, 10533, 41224, 41224, 28073, 28073, 
1571, 1571, 205, 205, 2918, 2918, 1542, 1542, 2721, 2721, 2597, 2597, 2312, 2312, 681, 681, 
26242, 26242, 44098, 44098, 1103, 1103, 59965, 59965, 29058, 29058, 26361, 26361, 48173, 48173, 5828, 5828, 
130, 130, 1602, 1602, 1871, 1871, 829, 829, 2946, 2946, 3065, 3065, 1325, 1325, 2756, 2756, 
34373, 34373, 34373, 34373, 11202, 11202, 11202, 11202, 64178, 64178, 64178, 64178, 54847, 54847, 54847, 54847, 
1861, 1861, 1861, 1861, 1474, 1474, 1474, 1474, 1202, 1202, 1202, 1202, 2367, 2367, 2367, 2367, 
15691, 15691, 15691, 15691, 3800, 3800, 3800, 3800, 37779, 37779, 37779, 37779, 20907, 20907, 20907, 20907, 
3147, 3147, 3147, 3147, 1752, 1752, 1752, 1752, 2707, 2707, 2707, 2707, 171, 171, 171, 171, 
16695, 16695, 16695, 16695, 16695, 16695, 16695, 16695, 37346, 37346, 37346, 37346, 37346, 37346, 37346, 37346, 
3127, 3127, 3127, 3127, 3127, 3127, 3127, 3127, 3042, 3042, 3042, 3042, 3042, 3042, 3042, 3042, 
12403, 12403, 12403, 12403, 12403, 12403, 12403, 12403, 52012, 52012, 52012, 52012, 52012, 52012, 52012, 52012, 
1907, 1907, 1907, 1907, 1907, 1907, 1907, 1907, 1836, 1836, 1836, 1836, 1836, 1836, 1836, 1836, 
64749, 64749, 1517, 1517, 
50791, 50791, 359, 359, 
60300, 60300, 1932, 1932,//34038, 34038, 758, 758, 
55457, 55457, 1441, 1441, 
};
const uint16_t zetas[256] __attribute__((aligned(32)))={
65202, 335, 11182, 54355, 54059, 11478, 13387, 52150, 33310, 32227, 51303, 14234, 20494, 45043, 43881, 21656, 
2226, 1103, 430, 2899, 555, 2774, 843, 2486, 2078, 1251, 871, 2458, 1550, 1779, 105, 3224, 
37798, 27739, 13131, 52406, 945, 64592, 60950, 4587, 50654, 14883, 23093, 42444, 6182, 59355, 5493, 60044, 
422, 2907, 587, 2742, 177, 3152, 3094, 235, 3038, 291, 2869, 460, 1574, 1755, 1653, 1676, 
32011, 33526, 33034, 32503, 10631, 54906, 30318, 35219, 29176, 36361, 46795, 18742, 36775, 28762, 12639, 52898, 
3083, 246, 778, 2551, 1159, 2170, 3182, 147, 2552, 777, 1483, 1846, 2727, 602, 1119, 2210, 
47051, 18486, 20100, 45437, 17561, 47976, 18525, 47012, 51106, 14431, 19529, 46008, 60261, 5276, 52918, 12619, 
1739, 1590, 644, 2685, 2457, 872, 349, 2980, 418, 2911, 329, 3000, 3173, 156, 3254, 75, 
34353, 31184, 20297, 45240, 25435, 40102, 2146, 63391, 58154, 7383, 15356, 50181, 24392, 41145, 33152, 32385, 
817, 2512, 1097, 2232, 603, 2726, 610, 2719, 1322, 2007, 2044, 1285, 1864, 1465, 384, 2945, 
44610, 20927, 59257, 6280, 10946, 54591, 50634, 14903, 24215, 41322, 54492, 11045, 16990, 48547, 14470, 51067, 
2114, 1215, 3193, 136, 1218, 2111, 1994, 1335, 2455, 874, 220, 3109, 2142, 1187, 1670, 1659, 
10336, 55201, 44039, 21498, 57603, 7934, 45338, 20199, 43035, 22502, 23211, 42326, 10907, 54630, 48094, 17443, 
2144, 1185, 1799, 1530, 2051, 1278, 794, 2535, 1819, 1510, 2475, 854, 2459, 870, 478, 2851, 
31637, 33900, 41677, 23860, 28644, 36893, 45279, 20258, 23998, 41539, 7757, 57780, 48114, 17423, 23132, 42405, 
3221, 108, 3021, 308, 996, 2333, 991, 2338, 958, 2371, 1869, 1460, 1522, 1807, 1628, 1701, 
};
#elif (NEWHOPECMPCT_N == 768)
const uint16_t zetas_exp[396] = {
13688, 13688, 2424, 2424, 
4702, 4702, 1886, 1886, 
22067, 22067, 22067, 22067, 22067, 22067, 22067, 22067, 40020, 40020, 40020, 40020, 40020, 40020, 40020, 40020, 
1715, 1715, 1715, 1715, 1715, 1715, 1715, 1715, 2644, 2644, 2644, 2644, 2644, 2644, 2644, 2644, 
10256, 10256, 10256, 10256, 13252, 13252, 13252, 13252, 29896, 29896, 29896, 29896, 1801, 1801, 1801, 1801, 
16, 16, 16, 16, 2500, 2500, 2500, 2500, 200, 200, 200, 200, 137, 137, 137, 137, 
1024, 1024, 61650, 61650, 12797, 12797, 49726, 49726, 38750, 38750, 25233, 25233, 25612, 25612, 20494, 20494, 
1024, 1024, 978, 978, 2429, 2429, 1854, 1854, 3166, 3166, 2065, 2065, 1548, 1548, 3342, 3342, 
8190, 34446, 36835, 4588, 47849, 5252, 8285, 32873, 45461, 58010, 43963, 4228, 33802, 54939, 62067, 31375, 
1278, 910, 2147, 1004, 1129, 2692, 2013, 2537, 3349, 410, 2107, 1668, 2826, 795, 755, 1295, 
64494, 19735, 16361, 40664, 13934, 10332, 61385, 46408, 56190, 47015, 37024, 36816, 53404, 44949, 11640, 14427, 
2286, 919, 2409, 728, 878, 604, 2377, 328, 126, 1575, 160, 2000, 2716, 2837, 376, 1243, 
17309, 52513, 16778, 45878, 30844, 25100, 55811, 42276, 63394, 5991, 1441, 18010, 4797, 27186, 16494, 9555, 
2845, 2721, 2186, 3126, 636, 1036, 643, 2852, 674, 1511, 801, 1370, 2621, 3378, 3438, 1491, 
8721, 8721, 1937, 1937, 
58769, 58769, 58769, 58769, 58769, 58769, 58769, 58769, 7489, 7489, 7489, 7489, 7489, 7489, 7489, 7489, 
2833, 2833, 2833, 2833, 2833, 2833, 2833, 2833, 2753, 2753, 2753, 2753, 2753, 2753, 2753, 2753, 
12418, 12418, 12418, 12418, 56020, 56020, 56020, 56020, 56911, 56911, 56911, 56911, 12114, 12114, 12114, 12114, 
2946, 2946, 2946, 2946, 2260, 2260, 2260, 2260, 2255, 2255, 2255, 2255, 594, 594, 594, 594, 
53593, 53593, 1650, 1650, 47318, 47318, 53385, 53385, 50371, 50371, 55148, 55148, 7034, 7034, 1214, 1214, 
729, 729, 2418, 2418, 470, 470, 2569, 2569, 3395, 3395, 2412, 2412, 2682, 2682, 2494, 2494, 
25858, 42617, 61081, 8418, 588, 42674, 40115, 41897, 47660, 8399, 5915, 6674, 63641, 31470, 41840, 152, 
2, 2041, 25, 3042, 1100, 2482, 3379, 3369, 3116, 2895, 923, 3346, 2585, 2030, 2928, 1176, 
56304, 48437, 34048, 32380, 34010, 31906, 27584, 49878, 45934, 17119, 32323, 43584, 65347, 63167, 26806, 7394, 
1008, 2229, 1280, 2172, 986, 1954, 3008, 3030, 110, 1375, 1731, 2624, 1987, 2367, 438, 2018, 
48399, 47925, 11527, 13005, 38370, 20873, 873, 10901, 50143, 4190, 53271, 10522, 3147, 39337, 26882, 8342, 
1935, 1717, 2951, 589, 226, 2825, 3305, 1557, 1631, 1374, 1687, 2074, 203, 809, 1026, 2454, 
};
 
const uint16_t zetas_inv_exp[404] = {
57195, 38655, 26200, 62390, 55015, 12266, 61347, 15394, 54636, 64664, 44664, 27167, 52532, 54010, 17612, 17138, 
1003, 2431, 2648, 3254, 1383, 1770, 2083, 1826, 1900, 152, 632, 3231, 2868, 506, 1740, 1522, 
55982, 49043, 38351, 60740, 47527, 64096, 59546, 2143, 23261, 9726, 40437, 34693, 19659, 48759, 13024, 48228, 
1966, 19, 79, 836, 2087, 2656, 1946, 2783, 605, 2814, 2421, 2821, 331, 1271, 736, 612, 
58143, 38731, 2370, 190, 21953, 33214, 48418, 19603, 15659, 37953, 33631, 31527, 33157, 31489, 17100, 9233, 
1439, 3019, 1090, 1470, 833, 1726, 2082, 3347, 427, 449, 1503, 2471, 1285, 2177, 1228, 2449, 
51110, 53897, 20588, 12133, 28721, 28513, 18522, 9347, 19129, 4152, 55205, 51603, 24873, 49176, 45802, 1043, 
2214, 3081, 620, 741, 1457, 3297, 1882, 3331, 3129, 1080, 2853, 2579, 2729, 1048, 2538, 1171, 
65385, 23697, 34067, 1896, 58863, 59622, 57138, 17877, 23640, 25422, 22863, 64949, 57119, 4456, 22920, 39679, 
2281, 529, 1427, 872, 111, 2534, 562, 341, 88, 78, 975, 2357, 415, 3432, 1416, 3455, 
34162, 3470, 10598, 31735, 61309, 21574, 7527, 20076, 32664, 57252, 60285, 17688, 60949, 28702, 31091, 57347, 
2162, 2702, 2662, 631, 1789, 1350, 3047, 108, 920, 1444, 765, 2328, 2453, 1310, 2547, 2179, 
64323, 64323, 58503, 58503, 10389, 10389, 15166, 15166, 12152, 12152, 18219, 18219, 63887, 63887, 11944, 11944, 
963, 963, 775, 775, 1045, 1045, 62, 62, 888, 888, 2987, 2987, 1039, 1039, 2728, 2728, 
45043, 45043, 39925, 39925, 40304, 40304, 26787, 26787, 15811, 15811, 52740, 52740, 3887, 3887, 64513, 64513, 
115, 115, 1909, 1909, 1392, 1392, 291, 291, 1603, 1603, 1028, 1028, 2479, 2479, 2433, 2433, 
53423, 53423, 53423, 53423, 8626, 8626, 8626, 8626, 9517, 9517, 9517, 9517, 53119, 53119, 53119, 53119, 
2863, 2863, 2863, 2863, 1202, 1202, 1202, 1202, 1197, 1197, 1197, 1197, 511, 511, 511, 511, 
63736, 63736, 63736, 63736, 35641, 35641, 35641, 35641, 52285, 52285, 52285, 52285, 55281, 55281, 55281, 55281, 
3320, 3320, 3320, 3320, 3257, 3257, 3257, 3257, 957, 957, 957, 957, 3441, 3441, 3441, 3441, 
58048, 58048, 58048, 58048, 58048, 58048, 58048, 58048, 6768, 6768, 6768, 6768, 6768, 6768, 6768, 6768, 
704, 704, 704, 704, 704, 704, 704, 704, 624, 624, 624, 624, 624, 624, 624, 624, 
25517, 25517, 25517, 25517, 25517, 25517, 25517, 25517, 43470, 43470, 43470, 43470, 43470, 43470, 43470, 43470, 
813, 813, 813, 813, 813, 813, 813, 813, 1742, 1742, 1742, 1742, 1742, 1742, 1742, 1742, 
56816, 56816, 1520, 1520, 
60835, 60835, 1571, 1571, 
34560, 34560, 1792, 1792, 
55830, 55830, 790, 790, 
46124, 46124, 1580, 1580, 
};
const uint16_t zetas[256] __attribute__((aligned(32)))= {
64494, 1043, 17309, 48228, 19735, 45802, 52513, 13024, 16361, 49176, 16778, 48759, 40664, 24873, 45878, 19659, 
2286, 1171, 2845, 612, 919, 2538, 2721, 736, 2409, 1048, 2186, 1271, 728, 2729, 3126, 331, 
13934, 51603, 30844, 34693, 10332, 55205, 25100, 40437, 61385, 4152, 55811, 9726, 46408, 19129, 42276, 23261, 
878, 2579, 636, 2821, 604, 2853, 1036, 2421, 2377, 1080, 643, 2814, 328, 3129, 2852, 605, 
56190, 9347, 63394, 2143, 47015, 18522, 5991, 59546, 37024, 28513, 1441, 64096, 36816, 28721, 18010, 47527, 
126, 3331, 674, 2783, 1575, 1882, 1511, 1946, 160, 3297, 801, 2656, 2000, 1457, 1370, 2087, 
53404, 12133, 4797, 60740, 44949, 20588, 27186, 38351, 11640, 53897, 16494, 49043, 14427, 51110, 9555, 55982, 
2716, 741, 2621, 836, 2837, 620, 3378, 79, 376, 3081, 3438, 19, 1243, 2214, 1491, 1966, 
56304, 9233, 48399, 17138, 48437, 17100, 47925, 17612, 34048, 31489, 11527, 54010, 32380, 33157, 13005, 52532, 
1008, 2449, 1935, 1522, 2229, 1228, 1717, 1740, 1280, 2177, 2951, 506, 2172, 1285, 589, 2868, 
34010, 31527, 38370, 27167, 31906, 33631, 20873, 44664, 27584, 37953, 873, 64664, 49878, 15659, 10901, 54636, 
986, 2471, 226, 3231, 1954, 1503, 2825, 632, 3008, 449, 3305, 152, 3030, 427, 1557, 1900, 
45934, 19603, 50143, 15394, 17119, 48418, 4190, 61347, 32323, 33214, 53271, 12266, 43584, 21953, 10522, 55015, 
110, 3347, 1631, 1826, 1375, 2082, 1374, 2083, 1731, 1726, 1687, 1770, 2624, 833, 2074, 1383, 
65347, 190, 3147, 62390, 63167, 2370, 39337, 26200, 26806, 38731, 26882, 38655, 7394, 58143, 8342, 57195, 
1987, 1470, 203, 3254, 2367, 1090, 809, 2648, 438, 3019, 1026, 2431, 2018, 1439, 2454, 1003, 
};
#endif
void ntt(int16_t *a)
{
  ntt_avx(a,zetas_exp);
}
void invntt(int16_t *a)
{
  invntt_avx(a,zetas_inv_exp);
}

/*************************************************
* Name:        basemul
*
* Description: Multiply two polynomials in Zq[X]/(X^NEWHOPE_NTT_POLY-gamma) 
*
* Arguments:   - poly *r:       pointer to output polynomial
*              - const poly *a: pointer to first input polynomial
*              - const poly *b: pointer to second input polynomial
**************************************************/
void basemul(int16_t *r, const int16_t *a, const int16_t *b, int16_t offset)
{
  int i,j;
  __m256i q, qinv, zr, z, t0h, t0l, t1;
  q = _mm256_load_si256((__m256i *)_16xq);
  qinv = _mm256_load_si256((__m256i *)_16xqinv);
  zr = _mm256_load_si256((__m256i *)&zetas[offset]);
  z = _mm256_load_si256((__m256i *)&zetas[offset+16]);
  __m256i rvec[NEWHOPECMPCT_NTT_POLY], avec[NEWHOPECMPCT_NTT_POLY], bvec[NEWHOPECMPCT_NTT_POLY];
  for(i=0;i<NEWHOPECMPCT_NTT_POLY;i++)
  {
    avec[i] =  _mm256_load_si256((__m256i *)&a[i*NEWHOPECMPCT_NTT_LENGTH]);
    bvec[i] =  _mm256_load_si256((__m256i *)&b[i*NEWHOPECMPCT_NTT_LENGTH]);
  }

  for(i=0;i<NEWHOPECMPCT_NTT_POLY;i++)
  {
    rvec[i] =  _mm256_set1_epi16(0);
    for(j=i+1;j<NEWHOPECMPCT_NTT_POLY;j++)
    {
      t0l = _mm256_mullo_epi16(avec[j],bvec[NEWHOPECMPCT_NTT_POLY+i-j]);
      t0h = _mm256_mulhi_epi16(avec[j],bvec[NEWHOPECMPCT_NTT_POLY+i-j]);
      t1  = _mm256_mullo_epi16(t0l,qinv);
      t1  = _mm256_mulhi_epi16(t1,q);
      t1  = _mm256_sub_epi16(t0h,t1);
      rvec[i]  = _mm256_add_epi16(rvec[i],t1);
    }
    if (j!=i+1)
    {
      t0l = _mm256_mullo_epi16(rvec[i],zr);
      t0h = _mm256_mulhi_epi16(rvec[i],z);
      t1  = _mm256_mulhi_epi16(t0l,q);
      rvec[i]  = _mm256_sub_epi16(t0h,t1);
    }
    for(j=0;j<i+1;j++)
    {
      t0l = _mm256_mullo_epi16(avec[j],bvec[i-j]);
      t0h = _mm256_mulhi_epi16(avec[j],bvec[i-j]);
      t1  = _mm256_mullo_epi16(t0l,qinv);
      t1  = _mm256_mulhi_epi16(t1,q);
      t1  = _mm256_sub_epi16(t0h,t1);
      rvec[i]  = _mm256_add_epi16(rvec[i],t1);
    }
  }
  for(i=0;i<NEWHOPECMPCT_NTT_POLY;i++)
  {
    _mm256_store_si256((__m256i *)&r[i*NEWHOPECMPCT_NTT_LENGTH], rvec[i]);
  }
}


