/*
   BLAKE2 reference source code package - reference C implementations

   Written in 2012 by Samuel Neves <sneves@dei.uc.pt>

   To the extent possible under law, the author(s) have dedicated all copyright
   and related and neighboring rights to this software to the public domain
   worldwide. This software is distributed without any warranty.

   You should have received a copy of the CC0 Public Domain Dedication along with
   this software. If not, see <http://creativecommons.org/publicdomain/zero/1.0/>.
*/

#include "crypto_hash.h"
#include <stdint.h>
#include <string.h>
#include <stdio.h>

#define ROTR32(x, c) (((x) >> (c)) | ((x) << (32-(c))))

static void store32( void *dst, uint32_t w )
{
#if __BYTE_ORDER__ == __ORDER_LITTLE_ENDIAN__
  *( uint32_t * )( dst ) = w;
#else
  uint8_t *p = ( uint8_t * )dst;
  *p++ = ( uint8_t )w; w >>= 8;
  *p++ = ( uint8_t )w; w >>= 8;
  *p++ = ( uint8_t )w; w >>= 8;
  *p++ = ( uint8_t )w; 
#endif
}

static uint32_t load32( const void *src )
{
#if __BYTE_ORDER__ == __ORDER_LITTLE_ENDIAN__
  return *( uint32_t * )( src );
#else
  const uint8_t *p = ( uint8_t * )src;
  uint32_t w = *p++;
  w |= ( uint32_t )( *p++ ) <<  8;
  w |= ( uint32_t )( *p++ ) << 16;
  w |= ( uint32_t )( *p++ ) << 24;
  return w;
#endif
}


int crypto_hash(unsigned char *out, const unsigned char *in, unsigned long long inlen)
{
  uint32_t v0, v1, v2, v3, v4, v5, v6, v7;
  uint32_t v8, v9, v10, v11, v12, v13, v14, v15;
  uint64_t ctr = 0;

  v0 = 0x6A09E667UL ^ 0x01010020UL;
  v1 = 0xBB67AE85UL;
  v2 = 0x3C6EF372UL;
  v3 = 0xA54FF53AUL;
  v4 = 0x510E527FUL;
  v5 = 0x9B05688CUL;
  v6 = 0x1F83D9ABUL;
  v7 = 0x5BE0CD19UL;

  while(inlen > 64)
  {
    const uint32_t m0  = load32(in +  0);
    const uint32_t m1  = load32(in +  4);
    const uint32_t m2  = load32(in +  8);
    const uint32_t m3  = load32(in + 12);
    const uint32_t m4  = load32(in + 16);
    const uint32_t m5  = load32(in + 20);
    const uint32_t m6  = load32(in + 24);
    const uint32_t m7  = load32(in + 28);
    const uint32_t m8  = load32(in + 32);
    const uint32_t m9  = load32(in + 36);
    const uint32_t m10 = load32(in + 40);
    const uint32_t m11 = load32(in + 44);
    const uint32_t m12 = load32(in + 48);
    const uint32_t m13 = load32(in + 52);
    const uint32_t m14 = load32(in + 56);
    const uint32_t m15 = load32(in + 60);

    const uint32_t iv0 = v0;
    const uint32_t iv1 = v1;
    const uint32_t iv2 = v2;
    const uint32_t iv3 = v3;
    const uint32_t iv4 = v4;
    const uint32_t iv5 = v5;
    const uint32_t iv6 = v6;
    const uint32_t iv7 = v7;

    ctr += 64;

    v8  = 0x6A09E667UL;
    v9  = 0xBB67AE85UL;
    v10 = 0x3C6EF372UL;
    v11 = 0xA54FF53AUL;
    v12 = 0x510E527FUL ^ ctr;
    v13 = 0x9B05688CUL ^ (ctr >> 32);
    v14 = 0x1F83D9ABUL;
    v15 = 0x5BE0CD19UL;

    v0 = v0 + v4 + m0; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m1; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m2; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m3; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m4; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m5; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m6; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m7; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m8; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m9; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m10; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m11; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m12; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m13; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m14; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m15; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
    v0 = v0 + v4 + m14; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m10; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m4; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m8; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m9; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m15; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m13; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m6; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m1; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m12; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m0; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m2; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m11; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m7; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m5; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m3; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
    v0 = v0 + v4 + m11; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m8; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m12; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m0; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m5; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m2; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m15; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m13; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m10; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m14; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m3; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m6; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m7; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m1; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m9; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m4; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
    v0 = v0 + v4 + m7; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m9; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m3; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m1; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m13; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m12; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m11; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m14; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m2; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m6; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m5; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m10; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m4; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m0; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m15; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m8; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
    v0 = v0 + v4 + m9; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m0; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m5; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m7; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m2; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m4; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m10; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m15; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m14; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m1; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m11; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m12; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m6; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m8; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m3; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m13; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
    v0 = v0 + v4 + m2; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m12; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m6; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m10; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m0; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m11; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m8; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m3; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m4; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m13; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m7; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m5; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m15; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m14; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m1; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m9; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
    v0 = v0 + v4 + m12; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m5; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m1; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m15; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m14; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m13; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m4; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m10; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m0; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m7; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m6; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m3; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m9; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m2; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m8; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m11; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
    v0 = v0 + v4 + m13; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m11; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m7; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m14; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m12; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m1; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m3; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m9; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m5; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m0; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m15; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m4; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m8; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m6; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m2; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m10; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
    v0 = v0 + v4 + m6; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m15; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m14; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m9; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m11; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m3; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m0; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m8; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m12; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m2; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m13; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m7; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m1; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m4; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m10; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m5; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
    v0 = v0 + v4 + m10; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m2; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m8; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m4; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m7; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m6; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m1; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m5; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m15; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m11; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m9; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m14; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m3; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m12; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m13; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m0; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
 

    v0 = v0 ^  v8 ^ iv0;
    v1 = v1 ^  v9 ^ iv1;
    v2 = v2 ^ v10 ^ iv2;
    v3 = v3 ^ v11 ^ iv3;
    v4 = v4 ^ v12 ^ iv4;
    v5 = v5 ^ v13 ^ iv5;
    v6 = v6 ^ v14 ^ iv6;
    v7 = v7 ^ v15 ^ iv7;

    inlen -= 64;
    in += 64;
  }

  do
  {
    uint8_t buffer[64] = {0};
    memcpy(buffer, in, inlen);
    const uint32_t m0  = load32(buffer +  0);
    const uint32_t m1  = load32(buffer +  4);
    const uint32_t m2  = load32(buffer +  8);
    const uint32_t m3  = load32(buffer + 12);
    const uint32_t m4  = load32(buffer + 16);
    const uint32_t m5  = load32(buffer + 20);
    const uint32_t m6  = load32(buffer + 24);
    const uint32_t m7  = load32(buffer + 28);
    const uint32_t m8  = load32(buffer + 32);
    const uint32_t m9  = load32(buffer + 36);
    const uint32_t m10 = load32(buffer + 40);
    const uint32_t m11 = load32(buffer + 44);
    const uint32_t m12 = load32(buffer + 48);
    const uint32_t m13 = load32(buffer + 52);
    const uint32_t m14 = load32(buffer + 56);
    const uint32_t m15 = load32(buffer + 60);

    const uint32_t iv0 = v0;
    const uint32_t iv1 = v1;
    const uint32_t iv2 = v2;
    const uint32_t iv3 = v3;
    const uint32_t iv4 = v4;
    const uint32_t iv5 = v5;
    const uint32_t iv6 = v6;
    const uint32_t iv7 = v7;

    ctr += inlen;

    v8  = 0x6A09E667UL;
    v9  = 0xBB67AE85UL;
    v10 = 0x3C6EF372UL;
    v11 = 0xA54FF53AUL;
    v12 = 0x510E527FUL ^ ctr;
    v13 = 0x9B05688CUL ^ (ctr >> 32);
    v14 = ~0x1F83D9ABUL;
    v15 = 0x5BE0CD19UL;

    v0 = v0 + v4 + m0; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m1; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m2; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m3; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m4; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m5; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m6; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m7; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m8; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m9; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m10; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m11; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m12; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m13; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m14; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m15; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
    v0 = v0 + v4 + m14; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m10; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m4; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m8; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m9; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m15; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m13; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m6; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m1; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m12; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m0; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m2; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m11; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m7; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m5; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m3; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
    v0 = v0 + v4 + m11; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m8; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m12; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m0; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m5; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m2; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m15; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m13; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m10; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m14; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m3; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m6; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m7; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m1; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m9; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m4; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
    v0 = v0 + v4 + m7; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m9; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m3; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m1; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m13; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m12; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m11; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m14; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m2; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m6; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m5; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m10; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m4; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m0; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m15; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m8; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
    v0 = v0 + v4 + m9; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m0; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m5; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m7; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m2; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m4; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m10; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m15; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m14; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m1; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m11; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m12; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m6; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m8; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m3; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m13; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
    v0 = v0 + v4 + m2; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m12; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m6; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m10; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m0; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m11; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m8; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m3; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m4; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m13; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m7; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m5; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m15; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m14; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m1; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m9; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
    v0 = v0 + v4 + m12; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m5; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m1; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m15; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m14; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m13; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m4; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m10; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m0; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m7; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m6; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m3; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m9; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m2; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m8; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m11; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
    v0 = v0 + v4 + m13; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m11; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m7; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m14; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m12; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m1; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m3; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m9; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m5; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m0; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m15; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m4; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m8; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m6; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m2; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m10; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
    v0 = v0 + v4 + m6; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m15; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m14; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m9; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m11; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m3; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m0; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m8; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m12; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m2; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m13; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m7; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m1; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m4; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m10; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m5; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 
    v0 = v0 + v4 + m10; 
    v12 = ROTR32(v12 ^ v0, 16); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8, 12); 
    v0 = v0 + v4 + m2; 
    v12 = ROTR32(v12 ^ v0,  8); 
    v8 = v8 + v12; 
    v4 = ROTR32(v4 ^ v8,  7); 
    v1 = v1 + v5 + m8; 
    v13 = ROTR32(v13 ^ v1, 16); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9, 12); 
    v1 = v1 + v5 + m4; 
    v13 = ROTR32(v13 ^ v1,  8); 
    v9 = v9 + v13; 
    v5 = ROTR32(v5 ^ v9,  7); 
    v2 = v2 + v6 + m7; 
    v14 = ROTR32(v14 ^ v2, 16); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10, 12); 
    v2 = v2 + v6 + m6; 
    v14 = ROTR32(v14 ^ v2,  8); 
    v10 = v10 + v14; 
    v6 = ROTR32(v6 ^ v10,  7); 
    v3 = v3 + v7 + m1; 
    v15 = ROTR32(v15 ^ v3, 16); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11, 12); 
    v3 = v3 + v7 + m5; 
    v15 = ROTR32(v15 ^ v3,  8); 
    v11 = v11 + v15; 
    v7 = ROTR32(v7 ^ v11,  7); 
    v0 = v0 + v5 + m15; 
    v15 = ROTR32(v15 ^ v0, 16); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10, 12); 
    v0 = v0 + v5 + m11; 
    v15 = ROTR32(v15 ^ v0,  8); 
    v10 = v10 + v15; 
    v5 = ROTR32(v5 ^ v10,  7); 
    v1 = v1 + v6 + m9; 
    v12 = ROTR32(v12 ^ v1, 16); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11, 12); 
    v1 = v1 + v6 + m14; 
    v12 = ROTR32(v12 ^ v1,  8); 
    v11 = v11 + v12; 
    v6 = ROTR32(v6 ^ v11,  7); 
    v2 = v2 + v7 + m3; 
    v13 = ROTR32(v13 ^ v2, 16); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8, 12); 
    v2 = v2 + v7 + m12; 
    v13 = ROTR32(v13 ^ v2,  8); 
    v8 = v8 + v13; 
    v7 = ROTR32(v7 ^ v8,  7); 
    v3 = v3 + v4 + m13; 
    v14 = ROTR32(v14 ^ v3, 16); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9, 12); 
    v3 = v3 + v4 + m0; 
    v14 = ROTR32(v14 ^ v3,  8); 
    v9 = v9 + v14; 
    v4 = ROTR32(v4 ^ v9,  7); 


    v0 = v0 ^  v8 ^ iv0;
    v1 = v1 ^  v9 ^ iv1;
    v2 = v2 ^ v10 ^ iv2;
    v3 = v3 ^ v11 ^ iv3;
    v4 = v4 ^ v12 ^ iv4;
    v5 = v5 ^ v13 ^ iv5;
    v6 = v6 ^ v14 ^ iv6;
    v7 = v7 ^ v15 ^ iv7;

    store32(out +  0, v0);
    store32(out +  4, v1);
    store32(out +  8, v2);
    store32(out + 12, v3);
    store32(out + 16, v4);
    store32(out + 20, v5);
    store32(out + 24, v6);
    store32(out + 28, v7);
  } while(0);
  return 0;
}

#if defined(BLAKE2S_SELFTEST)
#include <string.h>
#include "blake2.h"
#include "blake2-kat.h"
int main( int argc, char **argv )
{
  uint8_t key[BLAKE2S_KEYBYTES];
  uint8_t buf[KAT_LENGTH];
  size_t i;

  for( i = 0; i < BLAKE2S_KEYBYTES; ++i )
    key[i] = ( uint8_t )i;

  for( i = 0; i < KAT_LENGTH; ++i )
    buf[i] = ( uint8_t )i;

  for( i = 0; i < KAT_LENGTH; ++i )
  {
    uint8_t hash[BLAKE2S_OUTBYTES];
    crypto_hash( hash, buf, i );

    if( 0 != memcmp( hash, blake2s_kat[i], BLAKE2S_OUTBYTES ) )
    {
      puts( "error" );
      return -1;
    }
  }

  puts( "ok" );
  return 0;
}
#endif


