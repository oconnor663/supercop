/* 
   Optimized C code for tweaked Blue Midnight Wish - 256 programmed by Rune E. Jensen, December 2009.
*/

#include <stdio.h>
#include <string.h> 
#include "BlueMidnightWish.h"

#define rotl32(x,n)   (((x) << n) | ((x) >> (32 - n)))
#define rotr32(x,n)   (((x) >> n) | ((x) << (32 - n)))

#define shl(x,n)      ((x) << n)
#define shr(x,n)      ((x) >> n)

/* BlueMidnightWish256 initial double chaining pipe */
const u_int32_t i256p2[16] =
{   0x40414243ul, 0x44454647ul, 0x48494a4bul, 0x4c4d4e4ful,
    0x50515253ul, 0x54555657ul, 0x58595a5bul, 0x5c5d5e5ful,
    0x60616263ul, 0x64656667ul, 0x68696a6bul, 0x6c6d6e6ful,
    0x70717273ul, 0x74757677ul, 0x78797a7bul, 0x7c7d7e7ful,
};

#define hashState256(x)  ((x)->pipe->p256)

/* Components used for 224 and 256 bit version */
//#define s32_0(x)  (shr((x), 1) ^ shl((x), 3) ^ rotl32((x),  4) ^ rotl32((x), 19))
//#define s32_1(x)  (shr((x), 1) ^ shl((x), 2) ^ rotl32((x),  8) ^ rotl32((x), 23))
//#define s32_2(x)  (shr((x), 2) ^ shl((x), 1) ^ rotl32((x), 12) ^ rotl32((x), 25))
//#define s32_3(x)  (shr((x), 2) ^ shl((x), 2) ^ rotl32((x), 15) ^ rotl32((x), 29))
#define s32_4(x)  (shr((x), 1) ^ (x))
#define s32_5(x)  (shr((x), 2) ^ (x))
#define r32_01(x) rotl32((x),  3)
#define r32_02(x) rotl32((x),  7)
#define r32_03(x) rotl32((x), 13)
#define r32_04(x) rotl32((x), 16)
#define r32_05(x) rotl32((x), 19)
#define r32_06(x) rotl32((x), 23)
#define r32_07(x) rotl32((x), 27)


//#define s32_0(x)  (shr((x), 1) ^ shl((x), 3) ^ rotr32((rotl32((x), 19)), 15) ^ rotl32((x), 19))
//#define s32_1(x)  (shr((x), 1) ^ shl((x), 2) ^ rotr32((rotl32((x), 23)), 15) ^ rotl32((x), 23))


static __inline u_int32_t s32_0(const u_int32_t x)
{
	u_int32_t ans = shl(x, 3);
	u_int32_t roll_temp = rotl32(x, 19);
	ans ^= roll_temp;
	ans ^= shr(x, 1);
	ans ^= rotr32(roll_temp, 15);
	return ans; //(shr((x), 1) ^ shl((x), 3) ^ rotl32((x),  4) ^ rotl32((x), 19));
}

static __inline u_int32_t s32_1( u_int32_t x)
{
	u_int32_t ans = shl(x, 2);
	u_int32_t roll_temp = rotl32(x, 23);
	ans ^= roll_temp;
	ans ^= shr(x, 1);
	ans ^= rotr32(roll_temp, 15);
	return ans; //(shr((x), 1) ^ shl((x), 2) ^ rotl32((x),  8) ^ rotl32((x), 23));
}

static __inline u_int32_t s32_2( u_int32_t x)
{
	u_int32_t ans = shl(x, 1);
	u_int32_t roll_temp = rotl32(x, 12);
	ans ^= roll_temp;
	ans ^= shr(x, 2);
	ans ^= rotl32(roll_temp, 13);
	return ans; //(shr((x), 2) ^ shl((x), 1) ^ rotl32((x), 12) ^ rotl32((x), 25));
}

static __inline u_int32_t s32_3( u_int32_t x)
{
	u_int32_t ans = shl(x, 2);
	u_int32_t roll_temp = rotl32(x, 15);
	ans ^= roll_temp;
	ans ^= shr(x, 2);
	ans ^= rotl32(roll_temp, 14);
	return ans; //(shr((x), 2) ^ shl((x), 2) ^ rotl32((x), 15) ^ rotl32((x), 29));
}


#define Compression256()\
{\
				/* Mix the message block with the previous double pipe.       */\
                /*                              These variables are used for the tweak */\
		t256_20=t256_21=p256_08=p256[ 8]^data32[ 8];	td32_08=rotl32(data32[ 8], 9);\
		p256_09=p256[ 9]^data32[ 9];	td32_09=rotl32(data32[ 9],10);\
		p256_10=p256[10]^data32[10];	td32_10=rotl32(data32[10],11);\
		p256_11=p256[11]^data32[11];	td32_11=rotl32(data32[11],12);\
        p256_12=p256[12]^data32[12];	td32_12=rotl32(data32[12],13);\
        	p256_06=p256[ 6]^data32[ 6];	td32_06=rotl32(data32[ 6], 7);\
t256_19=p256_13=p256[13]^data32[13];	td32_13=rotl32(data32[13],14);  t256_19 -= p256_06;\
			p256_07=p256[ 7]^data32[ 7];	td32_07=rotl32(data32[ 7], 8);\
			p256_01=p256[ 1]^data32[ 1];    td32_01=rotl32(data32[ 1], 2);\
t256_18=p256_14=p256[14]^data32[14];	td32_14=rotl32(data32[14],15);	t256_16 = p256_01-p256_14;  t256_18 -= p256_07;\
		p256_15=p256[15]^data32[15];	td32_15=rotl32(data32[15],16);\
		\
		t256_17 = p256_15-p256_12;\
		\
		p256_05=p256[ 5]^data32[ 5];	td32_05=rotl32(data32[ 5], 6);\
		t256_20 -= p256_05;  t256_21 -= p256_01;\
		\
		p256_16 = ( p256_05+t256_18+p256_10+p256_13        );\
		p256_16  = s32_0(p256_16) + p256[ 1];\
		p256_17 = ( p256_06-p256_08+p256_11+p256_14-p256_15);\
		p256_17  = s32_1(p256_17) + p256[ 2];\
			p256_00=p256[ 0]^data32[ 0];	td32_00=rotl32(data32[ 0], 1);\
		p256_18 = ( p256_00+p256_07+p256_09+t256_17        );\
		p256_18  = s32_2(p256_18) + p256[ 3];\
		p256_19 = ( p256_00+t256_21        -p256_10+p256_13);\
		p256_19  = s32_3(p256_19) + p256[ 4];\
			p256_02=p256[ 2]^data32[ 2];	td32_02=rotl32(data32[ 2], 3);\
		p256_20 = ( t256_16+p256_02+p256_09-p256_11        );\
		p256_20  = s32_4(p256_20) + p256[ 5];\
			p256_03=p256[ 3]^data32[ 3];	td32_03=rotl32(data32[ 3], 4);\
		p256_21 = ( p256_03-p256_02+p256_10+t256_17        );\
		p256_21  = s32_0(p256_21) + p256[ 6];\
			p256_04=p256[ 4]^data32[ 4];	td32_04=rotl32(data32[ 4], 5);\
				p256_22 = ( p256_04-p256_00-p256_03-p256_11+p256_13);\
				p256_22  = s32_1(p256_22) + p256[ 7];\
				p256_23 = ( t256_16-p256_04-p256_05-p256_12        );\
				p256_23  = s32_2(p256_23) + p256[ 8];\
				p256_24 = ( p256_02-p256_05+t256_19        -p256_15);\
				p256_24  = s32_3(p256_24) + p256[ 9];\
				p256_25 = ( p256_00-p256_03+p256_06+t256_18        );\
				p256_25  = s32_4(p256_25) + p256[10];\
				p256_26 = ( t256_21        -p256_04-p256_07+p256_15);\
				p256_26  = s32_0(p256_26) + p256[11];\
				p256_27 = ( t256_20-p256_00-p256_02        +p256_09);\
				p256_27  = s32_1(p256_27) + p256[12];\
				p256_28 = ( p256_01+p256_03-p256_06-p256_09+p256_10);\
				p256_28  = s32_2(p256_28) + p256[13];\
				p256_29 = ( p256_02+p256_04+p256_07+p256_10+p256_11);\
				p256_29  = s32_3(p256_29) + p256[14];\
				p256_30 = ( p256_03+t256_20        -p256_11-p256_12);\
				p256_14  = s32_4(p256_30) + p256[15];\
				TempEven32 = p256_14;\
				p256_31 = ( p256_12-p256_04+t256_19-p256_09        );\
				p256_15  = s32_0(p256_31) + p256[ 0];\
				TempOdd32  = p256_15;\
\
				p256_00  = p256_16;\
				p256_01  = p256_17;\
				p256_02  = p256_18;\
				TempEven32+=p256_02;\
				p256_03  = p256_19;\
				TempOdd32 += p256_03;\
				p256_04  = p256_20;\
				TempEven32+= p256_04;\
				p256_05  = p256_21;\
				TempOdd32+= p256_05;\
				p256_06  = p256_22;\
				TempEven32+= p256_06;\
				p256_07  = p256_23;\
				TempOdd32 += p256_07;\
				p256_08  = p256_24;\
				TempEven32+= p256_08;\
				p256_09  = p256_25;\
				TempOdd32 += p256_09;\
				p256_10  = p256_26;\
				TempEven32+= p256_10;\
				p256_11  = p256_27;\
				TempOdd32 += p256_11;\
				p256_12  = p256_28;\
				TempEven32+= p256_12;\
				p256_13  = p256_29;\
				TempOdd32 += p256_13;\
\
				/* This is the Message expansion. */\
				/* It has 16 rounds.              */\
\
				p256_16  = s32_1(p256_00)    + s32_2(p256_01) + s32_3(p256_02) + s32_0(p256_03)\
                         + s32_1(p256_04)    + s32_2(p256_05) + s32_3(p256_06) + s32_0(p256_07)\
						 + s32_1(p256_08)    + s32_2(p256_09) + s32_3(p256_10) + s32_0(p256_11)\
						 + s32_1(p256_12)    + s32_2(p256_13) + s32_3(p256_14) + s32_0(p256_15)\
						 + ((td32_00      + td32_03      - td32_10 + 0x55555550u ) ^ p256[ 7]);\
				XL32 =  p256_16;\
				p256_17  = s32_1(p256_01)    + s32_2(p256_02) + s32_3(p256_03) + s32_0(p256_04)\
                         + s32_1(p256_05)    + s32_2(p256_06) + s32_3(p256_07) + s32_0(p256_08)\
						 + s32_1(p256_09)    + s32_2(p256_10) + s32_3(p256_11) + s32_0(p256_12)\
						 + s32_1(p256_13)    + s32_2(p256_14) + s32_3(p256_15) + s32_0(p256_16)\
						 + ((td32_01      + td32_04      - td32_11 + 0x5aaaaaa5u) ^ p256[ 8]);\
				XL32 ^= p256_17;\
/*				TempEven32 = p256_14  + p256_12  + p256_10  + p256_08  + p256_06  + p256_04  + p256_02; */\
/*				TempOdd32  = p256_15  + p256_13  + p256_11  + p256_09  + p256_07  + p256_05  + p256_03; */\
\
				/* expand32_22(18); */\
				p256_18  = TempEven32 + r32_01(p256_03)  + r32_02(p256_05)\
					                  + r32_03(p256_07)  + r32_04(p256_09)\
									  + r32_05(p256_11)  + r32_06(p256_13)\
									  + r32_07(p256_15)  + s32_4( p256_16 ) + s32_5( p256_17)\
									  + ((td32_02 + td32_05 - td32_12 + 0x5ffffffau) ^ p256[ 9]);\
				XL32 ^= p256_18;\
				/* expand32_21(19); */\
				p256_19 = TempOdd32   + r32_01(p256_04)  + r32_02(p256_06)\
                                      + r32_03(p256_08)  + r32_04(p256_10)\
							          + r32_05(p256_12)  + r32_06(p256_14)\
							          + r32_07(p256_16)  + s32_4( p256_17 ) + s32_5( p256_18)\
							          + ((td32_03 + td32_06 - td32_13 + 0x6555554fu) ^ p256[10]);\
				XL32 ^= p256_19;\
				TempEven32=TempEven32 + p256_16 - p256_02;\
				/* expand32_22(20); */\
				p256_20  = TempEven32 + r32_01(p256_05)  + r32_02(p256_07)\
					                  + r32_03(p256_09)  + r32_04(p256_11)\
									  + r32_05(p256_13)  + r32_06(p256_15)\
									  + r32_07(p256_17)  + s32_4( p256_18 ) + s32_5( p256_19)\
									  + ((td32_04 + td32_07 - td32_14 + 0x6aaaaaa4u) ^ p256[11]);\
				XL32 ^= p256_20;\
				TempOdd32 = TempOdd32 + p256_17 - p256_03;\
				/* expand32_21(21); */\
				p256_21 = TempOdd32   + r32_01(p256_06)  + r32_02(p256_08)\
                                      + r32_03(p256_10)  + r32_04(p256_12)\
							          + r32_05(p256_14)  + r32_06(p256_16)\
							          + r32_07(p256_18)  + s32_4( p256_19 ) + s32_5( p256_20)\
							          + ((td32_05 + td32_08 - td32_15 + 0x6ffffff9u) ^ p256[12]);\
				XL32 ^= p256_21;\
				TempEven32 = TempEven32 + p256_18 - p256_04;\
				/* expand32_22(22); */\
				p256_22  = TempEven32 + r32_01(p256_07)  + r32_02(p256_09)\
					                  + r32_03(p256_11)  + r32_04(p256_13)\
									  + r32_05(p256_15)  + r32_06(p256_17)\
									  + r32_07(p256_19)  + s32_4( p256_20 ) + s32_5( p256_21)\
									  + ((td32_06 + td32_09 - td32_00 + 0x7555554eu) ^ p256[13]);\
				XL32 ^= p256_22;\
				TempOdd32 = TempOdd32 + p256_19 - p256_05;\
				/* expand32_21(23); */\
				p256_23 = TempOdd32   + r32_01(p256_08)  + r32_02(p256_10)\
                                      + r32_03(p256_12)  + r32_04(p256_14)\
							          + r32_05(p256_16)  + r32_06(p256_18)\
							          + r32_07(p256_20)  + s32_4( p256_21 ) + s32_5( p256_22)\
							          + ((td32_07 + td32_10 - td32_01 + 0x7aaaaaa3u) ^ p256[14]);\
				XL32 ^= p256_23;\
				TempEven32 = TempEven32 + p256_20 - p256_06;\
				/* expand32_22(24); */\
				p256_24  = TempEven32 + r32_01(p256_09)  + r32_02(p256_11)\
					                  + r32_03(p256_13)  + r32_04(p256_15)\
									  + r32_05(p256_17)  + r32_06(p256_19)\
									  + r32_07(p256_21)  + s32_4( p256_22 ) + s32_5( p256_23)\
									  + ((td32_08 + td32_11 - td32_02 + 0x7ffffff8u) ^ p256[15]);\
				XH32 =  XL32^p256_24;\
				TempOdd32 = TempOdd32 + p256_21 - p256_07;\
				/* expand32_21(25); */\
				p256_25 = TempOdd32   + r32_01(p256_10)  + r32_02(p256_12)\
                                      + r32_03(p256_14)  + r32_04(p256_16)\
							          + r32_05(p256_18)  + r32_06(p256_20)\
							          + r32_07(p256_22)  + s32_4( p256_23 ) + s32_5( p256_24)\
							          + ((td32_09 + td32_12 - td32_03 + 0x8555554du) ^ p256[ 0]);\
				XH32 ^= p256_25;\
				TempEven32 = TempEven32 + p256_22 - p256_08;\
				/* expand32_22(26); */\
				p256_26  = TempEven32 + r32_01(p256_11)  + r32_02(p256_13)\
					                  + r32_03(p256_15)  + r32_04(p256_17)\
									  + r32_05(p256_19)  + r32_06(p256_21)\
									  + r32_07(p256_23)  + s32_4( p256_24 ) + s32_5( p256_25)\
									  + ((td32_10 + td32_13 - td32_04 + 0x8aaaaaa2u) ^ p256[ 1]);\
				XH32 ^= p256_26;\
				TempOdd32 = TempOdd32 + p256_23 - p256_09;\
				/* expand32_21(27); */\
				p256_27 = TempOdd32   + r32_01(p256_12)  + r32_02(p256_14)\
                                      + r32_03(p256_16)  + r32_04(p256_18)\
							          + r32_05(p256_20)  + r32_06(p256_22)\
							          + r32_07(p256_24)  + s32_4( p256_25 ) + s32_5( p256_26)\
							          + ((td32_11 + td32_14 - td32_05 + 0x8ffffff7u) ^ p256[ 2]);\
				XH32 ^= p256_27;\
				TempEven32 = TempEven32 + p256_24 - p256_10;\
				/* expand32_22(28); */\
				p256_28  = TempEven32 + r32_01(p256_13)  + r32_02(p256_15)\
					                  + r32_03(p256_17)  + r32_04(p256_19)\
									  + r32_05(p256_21)  + r32_06(p256_23)\
									  + r32_07(p256_25)  + s32_4( p256_26 ) + s32_5( p256_27)\
									  + ((td32_12 + td32_15 - td32_06 + 0x9555554cu) ^ p256[ 3]);\
				XH32 ^= p256_28;\
				TempOdd32 = TempOdd32 + p256_25 - p256_11;\
				/* expand32_21(29); */\
				p256_29 = TempOdd32   + r32_01(p256_14)  + r32_02(p256_16)\
                                      + r32_03(p256_18)  + r32_04(p256_20)\
							          + r32_05(p256_22)  + r32_06(p256_24)\
							          + r32_07(p256_26)  + s32_4( p256_27 ) + s32_5( p256_28)\
							          + ((td32_13 + td32_00 - td32_07 + 0x9aaaaaa1u) ^ p256[ 4]);\
				XH32 ^= p256_29;\
				TempEven32 = TempEven32 + p256_26 - p256_12;\
				/* expand32_22(30); */\
				p256_30  = TempEven32 + r32_01(p256_15)  + r32_02(p256_17)\
					                  + r32_03(p256_19)  + r32_04(p256_21)\
									  + r32_05(p256_23)  + r32_06(p256_25)\
									  + r32_07(p256_27)  + s32_4( p256_28 ) + s32_5( p256_29)\
									  + ((td32_14 + td32_01 - td32_08 + 0x9ffffff6u) ^ p256[ 5]);\
				XH32 ^= p256_30;\
				TempOdd32 = TempOdd32 + p256_27 - p256_13;\
				/* expand32_21(31); */\
				p256_31 = TempOdd32   + r32_01(p256_16)  + r32_02(p256_18)\
                                      + r32_03(p256_20)  + r32_04(p256_22)\
							          + r32_05(p256_24)  + r32_06(p256_26)\
							          + r32_07(p256_28)  + s32_4( p256_29 ) + s32_5( p256_30)\
							          + ((td32_15 + td32_02 - td32_09 + 0xa555554bu) ^ p256[ 6]);\
				XH32 ^= p256_31;\
\
				/*  Compute the double chaining pipe for the next message block. */\
				p256[0] =                       (shl(XH32, 5) ^ shr(p256_16,5) ^ data32[ 0]) + (    XL32    ^ p256_24 ^ p256_00);\
				p256[1] =                       (shr(XH32, 7) ^ shl(p256_17,8) ^ data32[ 1]) + (    XL32    ^ p256_25 ^ p256_01);\
				p256[2] =                       (shr(XH32, 5) ^ shl(p256_18,5) ^ data32[ 2]) + (    XL32    ^ p256_26 ^ p256_02);\
				p256[3] =                       (shr(XH32, 1) ^ shl(p256_19,5) ^ data32[ 3]) + (    XL32    ^ p256_27 ^ p256_03);\
				p256[4] =                       (shr(XH32, 3) ^     p256_20    ^ data32[ 4]) + (    XL32    ^ p256_28 ^ p256_04);\
				p256[5] =                       (shl(XH32, 6) ^ shr(p256_21,6) ^ data32[ 5]) + (    XL32    ^ p256_29 ^ p256_05);\
				p256[6] =                       (shr(XH32, 4) ^ shl(p256_22,6) ^ data32[ 6]) + (    XL32    ^ p256_30 ^ p256_06);\
				p256[7] =                       (shr(XH32,11) ^ shl(p256_23,2) ^ data32[ 7]) + (    XL32    ^ p256_31 ^ p256_07);\
\
				p256[ 8] = rotl32(p256[4], 9) + (    XH32     ^     p256_24    ^ data32[ 8]) + (shl(XL32,8) ^ p256_23 ^ p256_08);\
				p256[ 9] = rotl32(p256[5],10) + (    XH32     ^     p256_25    ^ data32[ 9]) + (shr(XL32,6) ^ p256_16 ^ p256_09);\
				p256[10] = rotl32(p256[6],11) + (    XH32     ^     p256_26    ^ data32[10]) + (shl(XL32,6) ^ p256_17 ^ p256_10);\
				p256[11] = rotl32(p256[7],12) + (    XH32     ^     p256_27    ^ data32[11]) + (shl(XL32,4) ^ p256_18 ^ p256_11);\
				p256[12] = rotl32(p256[0],13) + (    XH32     ^     p256_28    ^ data32[12]) + (shr(XL32,3) ^ p256_19 ^ p256_12);\
				p256[13] = rotl32(p256[1],14) + (    XH32     ^     p256_29    ^ data32[13]) + (shr(XL32,4) ^ p256_20 ^ p256_13);\
				p256[14] = rotl32(p256[2],15) + (    XH32     ^     p256_30    ^ data32[14]) + (shr(XL32,7) ^ p256_21 ^ p256_14);\
				p256[15] = rotl32(p256[3],16) + (    XH32     ^     p256_31    ^ data32[15]) + (shr(XL32,2) ^ p256_22 ^ p256_15);\
}

#define FinalCompression256()\
{\
				/* Mix the final double pipe with a constant.        */\
                /*                                 This is the tweak */\
 t256_20=t256_21=p256_08=p256[ 8]^0xaaaaaaa8u;	td32_08=rotl32(p256[ 8], 9);\
				 p256_09=p256[ 9]^0xaaaaaaa9u;	td32_09=rotl32(p256[ 9],10);\
				 p256_10=p256[10]^0xaaaaaaaau;	td32_10=rotl32(p256[10],11);\
				 p256_11=p256[11]^0xaaaaaaabu;	td32_11=rotl32(p256[11],12);\
                 p256_12=p256[12]^0xaaaaaaacu;	td32_12=rotl32(p256[12],13);\
				 	p256_06=p256[ 6]^0xaaaaaaa6u;	td32_06=rotl32(p256[ 6], 7);\
		 t256_19=p256_13=p256[13]^0xaaaaaaadu;	td32_13=rotl32(p256[13],14);  t256_19 -= p256_06;\
				 	p256_07=p256[ 7]^0xaaaaaaa7u;	td32_07=rotl32(p256[ 7], 8);\
					p256_01=p256[ 1]^0xaaaaaaa1u; td32_01=rotl32(p256[ 1], 2);\
		 t256_18=p256_14=p256[14]^0xaaaaaaaeu;	td32_14=rotl32(p256[14],15);  t256_16 = p256_01-p256_14;  t256_18 -= p256_07;\
				 p256_15=p256[15]^0xaaaaaaafu;	td32_15=rotl32(p256[15],16);\
\
				\
				t256_17 = p256_15-p256_12;\
				\
				\
				p256_05=p256[ 5]^0xaaaaaaa5u;	td32_05=rotl32(p256[ 5], 6);\
				t256_20 -= p256_05;  t256_21 -= p256_01;\
				\
				\
\
				p256_16 = ( p256_05+t256_18+p256_10+p256_13        );\
				p256_16  = s32_0(p256_16) + 0xaaaaaaa1u;\
				p256_17 = ( p256_06-p256_08+p256_11+p256_14-p256_15);\
				p256_17  = s32_1(p256_17) + 0xaaaaaaa2u;\
					p256_00=p256[ 0]^0xaaaaaaa0u;	td32_00=rotl32(p256[ 0], 1);\
				p256_18 = ( p256_00+p256_07+p256_09+t256_17        );\
				p256_18  = s32_2(p256_18) + 0xaaaaaaa3u;\
				p256_19 = ( p256_00+t256_21        -p256_10+p256_13);\
				p256_19  = s32_3(p256_19) + 0xaaaaaaa4u;\
					p256_02=p256[ 2]^0xaaaaaaa2u;	td32_02=rotl32(p256[ 2], 3);\
				p256_20 = ( t256_16+p256_02+p256_09-p256_11        );\
				p256_20  = s32_4(p256_20) + 0xaaaaaaa5u;\
					p256_03=p256[ 3]^0xaaaaaaa3u;	td32_03=rotl32(p256[ 3], 4);\
	 			p256_21 = ( p256_03-p256_02+p256_10+t256_17        );\
				p256_21  = s32_0(p256_21) + 0xaaaaaaa6u;\
                	p256_04=p256[ 4]^0xaaaaaaa4u;	td32_04=rotl32(p256[ 4], 5);\
				p256_22 = ( p256_04-p256_00-p256_03-p256_11+p256_13);\
				p256_22  = s32_1(p256_22) + 0xaaaaaaa7u;\
				p256_23 = ( t256_16-p256_04-p256_05-p256_12        );\
				p256_23  = s32_2(p256_23) + 0xaaaaaaa8u;\
				p256_24 = ( p256_02-p256_05+t256_19        -p256_15);\
				p256_24  = s32_3(p256_24) + 0xaaaaaaa9u;\
				p256_25 = ( p256_00-p256_03+p256_06+t256_18        );\
				p256_25  = s32_4(p256_25) + 0xaaaaaaaau;\
				p256_26 = ( t256_21        -p256_04-p256_07+p256_15);\
				p256_26  = s32_0(p256_26) + 0xaaaaaaabu;\
				p256_27 = ( t256_20-p256_00-p256_02        +p256_09);\
				p256_27  = s32_1(p256_27) + 0xaaaaaaacu;\
				p256_28 = ( p256_01+p256_03-p256_06-p256_09+p256_10);\
				p256_28  = s32_2(p256_28) + 0xaaaaaaadu;\
				p256_29 = ( p256_02+p256_04+p256_07+p256_10+p256_11);\
				p256_29  = s32_3(p256_29) + 0xaaaaaaaeu;\
				p256_30 = ( p256_03+t256_20        -p256_11-p256_12);\
				p256_14  = s32_4(p256_30) + 0xaaaaaaafu;\
				TempEven32 = p256_14;\
				p256_31 = ( p256_12-p256_04+t256_19-p256_09        );\
				p256_15  = s32_0(p256_31) + 0xaaaaaaa0u;\
				TempOdd32  = p256_15;\
\
				p256_00  = p256_16;\
				p256_01  = p256_17;\
				p256_02  = p256_18;\
				TempEven32+=p256_02;\
				p256_03  = p256_19;\
				TempOdd32 += p256_03;\
				p256_04  = p256_20;\
				TempEven32+= p256_04;\
				p256_05  = p256_21;\
				TempOdd32+= p256_05;\
				p256_06  = p256_22;\
				TempEven32+= p256_06;\
				p256_07  = p256_23;\
				TempOdd32 += p256_07;\
				p256_08  = p256_24;\
				TempEven32+= p256_08;\
				p256_09  = p256_25;\
				TempOdd32 += p256_09;\
				p256_10  = p256_26;\
				TempEven32+= p256_10;\
				p256_11  = p256_27;\
				TempOdd32 += p256_11;\
				p256_12  = p256_28;\
				TempEven32+= p256_12;\
				p256_13  = p256_29;\
				TempOdd32 += p256_13;\
\
				/* This is the Message expansion. */\
				/* It has 16 rounds.              */\
\
				p256_16  = s32_1(p256_00)    + s32_2(p256_01) + s32_3(p256_02) + s32_0(p256_03)\
                         + s32_1(p256_04)    + s32_2(p256_05) + s32_3(p256_06) + s32_0(p256_07)\
						 + s32_1(p256_08)    + s32_2(p256_09) + s32_3(p256_10) + s32_0(p256_11)\
						 + s32_1(p256_12)    + s32_2(p256_13) + s32_3(p256_14) + s32_0(p256_15)\
						 + ((td32_00      + td32_03      - td32_10 + 0x55555550u ) ^ 0xaaaaaaa7u);\
				XL32 =  p256_16;\
				p256_17  = s32_1(p256_01)    + s32_2(p256_02) + s32_3(p256_03) + s32_0(p256_04)\
                         + s32_1(p256_05)    + s32_2(p256_06) + s32_3(p256_07) + s32_0(p256_08)\
						 + s32_1(p256_09)    + s32_2(p256_10) + s32_3(p256_11) + s32_0(p256_12)\
						 + s32_1(p256_13)    + s32_2(p256_14) + s32_3(p256_15) + s32_0(p256_16)\
						 + ((td32_01      + td32_04      - td32_11 + 0x5aaaaaa5u) ^ 0xaaaaaaa8u);\
				XL32 ^= p256_17;\
				/* TempEven32 = p256_14  + p256_12  + p256_10  + p256_08  + p256_06  + p256_04  + p256_02; */\
				/* TempOdd32  = p256_15  + p256_13  + p256_11  + p256_09  + p256_07  + p256_05  + p256_03; */\
\
				/* expand32_22(18); */\
				p256_18  = TempEven32 + r32_01(p256_03)  + r32_02(p256_05)\
					                  + r32_03(p256_07)  + r32_04(p256_09)\
									  + r32_05(p256_11)  + r32_06(p256_13)\
									  + r32_07(p256_15)  + s32_4( p256_16 ) + s32_5( p256_17)\
									  + ((td32_02 + td32_05 - td32_12 + 0x5ffffffau) ^ 0xaaaaaaa9u);\
				XL32 ^= p256_18;\
				/* expand32_21(19); */\
				p256_19 = TempOdd32   + r32_01(p256_04)  + r32_02(p256_06)\
                                      + r32_03(p256_08)  + r32_04(p256_10)\
							          + r32_05(p256_12)  + r32_06(p256_14)\
							          + r32_07(p256_16)  + s32_4( p256_17 ) + s32_5( p256_18)\
							          + ((td32_03 + td32_06 - td32_13 + 0x6555554fu) ^ 0xaaaaaaaau);\
				XL32 ^= p256_19;\
				TempEven32=TempEven32 + p256_16 - p256_02;\
				/* expand32_22(20); */\
				p256_20  = TempEven32 + r32_01(p256_05)  + r32_02(p256_07)\
					                  + r32_03(p256_09)  + r32_04(p256_11)\
									  + r32_05(p256_13)  + r32_06(p256_15)\
									  + r32_07(p256_17)  + s32_4( p256_18 ) + s32_5( p256_19)\
									  + ((td32_04 + td32_07 - td32_14 + 0x6aaaaaa4u) ^ 0xaaaaaaabu);\
				XL32 ^= p256_20;\
				TempOdd32 = TempOdd32 + p256_17 - p256_03;\
				/* expand32_21(21); */\
				p256_21 = TempOdd32   + r32_01(p256_06)  + r32_02(p256_08)\
                                      + r32_03(p256_10)  + r32_04(p256_12)\
							          + r32_05(p256_14)  + r32_06(p256_16)\
							          + r32_07(p256_18)  + s32_4( p256_19 ) + s32_5( p256_20)\
							          + ((td32_05 + td32_08 - td32_15 + 0x6ffffff9u) ^ 0xaaaaaaacu);\
				XL32 ^= p256_21;\
				TempEven32 = TempEven32 + p256_18 - p256_04;\
				/* expand32_22(22); */\
				p256_22  = TempEven32 + r32_01(p256_07)  + r32_02(p256_09)\
					                  + r32_03(p256_11)  + r32_04(p256_13)\
									  + r32_05(p256_15)  + r32_06(p256_17)\
									  + r32_07(p256_19)  + s32_4( p256_20 ) + s32_5( p256_21)\
									  + ((td32_06 + td32_09 - td32_00 + 0x7555554eu) ^ 0xaaaaaaadu);\
				XL32 ^= p256_22;\
				TempOdd32 = TempOdd32 + p256_19 - p256_05;\
				/* expand32_21(23); */\
				p256_23 = TempOdd32   + r32_01(p256_08)  + r32_02(p256_10)\
                                      + r32_03(p256_12)  + r32_04(p256_14)\
							          + r32_05(p256_16)  + r32_06(p256_18)\
							          + r32_07(p256_20)  + s32_4( p256_21 ) + s32_5( p256_22)\
							          + ((td32_07 + td32_10 - td32_01 + 0x7aaaaaa3u) ^ 0xaaaaaaaeu);\
				XL32 ^= p256_23;\
				TempEven32 = TempEven32 + p256_20 - p256_06;\
				/* expand32_22(24); */\
				p256_24  = TempEven32 + r32_01(p256_09)  + r32_02(p256_11)\
					                  + r32_03(p256_13)  + r32_04(p256_15)\
									  + r32_05(p256_17)  + r32_06(p256_19)\
									  + r32_07(p256_21)  + s32_4( p256_22 ) + s32_5( p256_23)\
									  + ((td32_08 + td32_11 - td32_02 + 0x7ffffff8u) ^ 0xaaaaaaafu);\
				XH32 =  XL32^p256_24;\
				TempOdd32 = TempOdd32 + p256_21 - p256_07;\
				/* expand32_21(25); */\
				p256_25 = TempOdd32   + r32_01(p256_10)  + r32_02(p256_12)\
                                      + r32_03(p256_14)  + r32_04(p256_16)\
							          + r32_05(p256_18)  + r32_06(p256_20)\
							          + r32_07(p256_22)  + s32_4( p256_23 ) + s32_5( p256_24)\
							          + ((td32_09 + td32_12 - td32_03 + 0x8555554du) ^ 0xaaaaaaa0u);\
				XH32 ^= p256_25;\
				TempEven32 = TempEven32 + p256_22 - p256_08;\
				/* expand32_22(26); */\
				p256_26  = TempEven32 + r32_01(p256_11)  + r32_02(p256_13)\
					                  + r32_03(p256_15)  + r32_04(p256_17)\
									  + r32_05(p256_19)  + r32_06(p256_21)\
									  + r32_07(p256_23)  + s32_4( p256_24 ) + s32_5( p256_25)\
									  + ((td32_10 + td32_13 - td32_04 + 0x8aaaaaa2u) ^ 0xaaaaaaa1u);\
				XH32 ^= p256_26;\
				TempOdd32 = TempOdd32 + p256_23 - p256_09;\
				/* expand32_21(27); */\
				p256_27 = TempOdd32   + r32_01(p256_12)  + r32_02(p256_14)\
                                      + r32_03(p256_16)  + r32_04(p256_18)\
							          + r32_05(p256_20)  + r32_06(p256_22)\
							          + r32_07(p256_24)  + s32_4( p256_25 ) + s32_5( p256_26)\
							          + ((td32_11 + td32_14 - td32_05 + 0x8ffffff7u) ^ 0xaaaaaaa2u);\
				XH32 ^= p256_27;\
				TempEven32 = TempEven32 + p256_24 - p256_10;\
				/* expand32_22(28); */\
				p256_28  = TempEven32 + r32_01(p256_13)  + r32_02(p256_15)\
					                  + r32_03(p256_17)  + r32_04(p256_19)\
									  + r32_05(p256_21)  + r32_06(p256_23)\
									  + r32_07(p256_25)  + s32_4( p256_26 ) + s32_5( p256_27)\
									  + ((td32_12 + td32_15 - td32_06 + 0x9555554cu) ^ 0xaaaaaaa3u);\
				XH32 ^= p256_28;\
				TempOdd32 = TempOdd32 + p256_25 - p256_11;\
				/* expand32_21(29); */\
				p256_29 = TempOdd32   + r32_01(p256_14)  + r32_02(p256_16)\
                                      + r32_03(p256_18)  + r32_04(p256_20)\
							          + r32_05(p256_22)  + r32_06(p256_24)\
							          + r32_07(p256_26)  + s32_4( p256_27 ) + s32_5( p256_28)\
							          + ((td32_13 + td32_00 - td32_07 + 0x9aaaaaa1u) ^ 0xaaaaaaa4u);\
				XH32 ^= p256_29;\
				TempEven32 = TempEven32 + p256_26 - p256_12;\
				/* expand32_22(30); */\
				p256_30  = TempEven32 + r32_01(p256_15)  + r32_02(p256_17)\
					                  + r32_03(p256_19)  + r32_04(p256_21)\
									  + r32_05(p256_23)  + r32_06(p256_25)\
									  + r32_07(p256_27)  + s32_4( p256_28 ) + s32_5( p256_29)\
									  + ((td32_14 + td32_01 - td32_08 + 0x9ffffff6u) ^ 0xaaaaaaa5u);\
				XH32 ^= p256_30;\
				TempOdd32 = TempOdd32 + p256_27 - p256_13;\
				/* expand32_21(31); */\
				p256_31 = TempOdd32   + r32_01(p256_16)  + r32_02(p256_18)\
                                      + r32_03(p256_20)  + r32_04(p256_22)\
							          + r32_05(p256_24)  + r32_06(p256_26)\
							          + r32_07(p256_28)  + s32_4( p256_29 ) + s32_5( p256_30)\
							          + ((td32_15 + td32_02 - td32_09 + 0xa555554bu) ^ 0xaaaaaaa6u);\
				XH32 ^= p256_31;\
\
				/*  Compute the double hash output. */\
				p256[0] =                       (shl(XH32, 5) ^ shr(p256_16,5) ^ p256[ 0]) + (    XL32    ^ p256_24 ^ p256_00);\
				p256[1] =                       (shr(XH32, 7) ^ shl(p256_17,8) ^ p256[ 1]) + (    XL32    ^ p256_25 ^ p256_01);\
				p256[2] =                       (shr(XH32, 5) ^ shl(p256_18,5) ^ p256[ 2]) + (    XL32    ^ p256_26 ^ p256_02);\
				p256[3] =                       (shr(XH32, 1) ^ shl(p256_19,5) ^ p256[ 3]) + (    XL32    ^ p256_27 ^ p256_03);\
				p256[4] =                       (shr(XH32, 3) ^     p256_20    ^ p256[ 4]) + (    XL32    ^ p256_28 ^ p256_04);\
				p256[5] =                       (shl(XH32, 6) ^ shr(p256_21,6) ^ p256[ 5]) + (    XL32    ^ p256_29 ^ p256_05);\
				p256[6] =                       (shr(XH32, 4) ^ shl(p256_22,6) ^ p256[ 6]) + (    XL32    ^ p256_30 ^ p256_06);\
				p256[7] =                       (shr(XH32,11) ^ shl(p256_23,2) ^ p256[ 7]) + (    XL32    ^ p256_31 ^ p256_07);\
\
				p256[ 8] = rotl32(p256[4], 9) + (    XH32     ^     p256_24    ^ p256[ 8]) + (shl(XL32,8) ^ p256_23 ^ p256_08);\
				p256[ 9] = rotl32(p256[5],10) + (    XH32     ^     p256_25    ^ p256[ 9]) + (shr(XL32,6) ^ p256_16 ^ p256_09);\
				p256[10] = rotl32(p256[6],11) + (    XH32     ^     p256_26    ^ p256[10]) + (shl(XL32,6) ^ p256_17 ^ p256_10);\
				p256[11] = rotl32(p256[7],12) + (    XH32     ^     p256_27    ^ p256[11]) + (shl(XL32,4) ^ p256_18 ^ p256_11);\
				p256[12] = rotl32(p256[0],13) + (    XH32     ^     p256_28    ^ p256[12]) + (shr(XL32,3) ^ p256_19 ^ p256_12);\
				p256[13] = rotl32(p256[1],14) + (    XH32     ^     p256_29    ^ p256[13]) + (shr(XL32,4) ^ p256_20 ^ p256_13);\
				p256[14] = rotl32(p256[2],15) + (    XH32     ^     p256_30    ^ p256[14]) + (shr(XL32,7) ^ p256_21 ^ p256_14);\
				p256[15] = rotl32(p256[3],16) + (    XH32     ^     p256_31    ^ p256[15]) + (shr(XL32,2) ^ p256_22 ^ p256_15);\
}

HashReturn Init(hashState *state, int hashbitlen)
{
		state->hashbitlen = 256;
		state->bits_processed = 0;
		state->unprocessed_bits = 0;
		memcpy(hashState256(state)->DoublePipe, i256p2,  16 * sizeof(u_int32_t));
		return(SUCCESS);
}

HashReturn Update256(hashState *state, const BitSequence *data, DataLength databitlen)
{
	u_int32_t *data32, *p256;
	u_int32_t XL32, XH32, TempEven32, TempOdd32;
    u_int32_t p256_00, p256_01, p256_02, p256_03, p256_04, p256_05, p256_06, p256_07;
    u_int32_t p256_08, p256_09, p256_10, p256_11, p256_12, p256_13, p256_14, p256_15;
    u_int32_t p256_16, p256_17, p256_18, p256_19, p256_20, p256_21, p256_22, p256_23;
    u_int32_t p256_24, p256_25, p256_26, p256_27, p256_28, p256_29, p256_30, p256_31;
    u_int32_t t256_16, t256_17, t256_18, t256_19, t256_20, t256_21;
	u_int32_t td32_00, td32_01, td32_02, td32_03, td32_04, td32_05, td32_06, td32_07;
	u_int32_t td32_08, td32_09, td32_10, td32_11, td32_12, td32_13, td32_14, td32_15;
	
	int LastBytes;

	if (state->unprocessed_bits > 0)
	{
		if ( state->unprocessed_bits + databitlen > BlueMidnightWish256_BLOCK_SIZE * 8)
		{
			return BAD_CONSECUTIVE_CALL_TO_UPDATE;
		}
		else
		{
			LastBytes = (int)databitlen >> 3; // LastBytes = databitlen / 8
			memcpy(hashState256(state)->LastPart + (state->unprocessed_bits >> 3), data, LastBytes );
			state->unprocessed_bits += (int)databitlen;
			databitlen = state->unprocessed_bits;
			data32 = (u_int32_t *)hashState256(state)->LastPart;
		}
	}
	else 
		data32 = (u_int32_t *)data;
	
	p256 = hashState256(state)->DoublePipe;
	

	while (databitlen >= BlueMidnightWish256_BLOCK_SIZE * 8)
	{
		databitlen -= BlueMidnightWish256_BLOCK_SIZE * 8;
		// #1 Between comments #1 and #2 add algorithm specifics

		state->bits_processed += BlueMidnightWish256_BLOCK_SIZE * 8;
		
		
		t256_20=t256_21=p256_08=p256[ 8]^data32[ 8];	td32_08=rotl32(data32[ 8], 9);
		p256_09=p256[ 9]^data32[ 9];	td32_09=rotl32(data32[ 9],10);
		p256_10=p256[10]^data32[10];	td32_10=rotl32(data32[10],11);
		p256_11=p256[11]^data32[11];	td32_11=rotl32(data32[11],12);
        p256_12=p256[12]^data32[12];	td32_12=rotl32(data32[12],13);
       	p256_06=p256[ 6]^data32[ 6];	td32_06=rotl32(data32[ 6], 7);
t256_19=p256_13=p256[13]^data32[13];	td32_13=rotl32(data32[13],14);  t256_19 -= p256_06;
		p256_07=p256[ 7]^data32[ 7];	td32_07=rotl32(data32[ 7], 8);
		p256_01=p256[ 1]^data32[ 1];    td32_01=rotl32(data32[ 1], 2);
t256_18=p256_14=p256[14]^data32[14];	td32_14=rotl32(data32[14],15);	t256_16 = p256_01-p256_14;  t256_18 -= p256_07;
		p256_15=p256[15]^data32[15];	td32_15=rotl32(data32[15],16);

		
		t256_17 = p256_15-p256_12;
		
		p256_05=p256[ 5]^data32[ 5];	td32_05=rotl32(data32[ 5], 6);
		t256_20 -= p256_05;  t256_21 -= p256_01;
		

		p256_16 = ( p256_05+t256_18+p256_10+p256_13        );
		p256_16  = s32_0(p256_16) + p256[ 1];
		p256_17 = ( p256_06-p256_08+p256_11+p256_14-p256_15);
		p256_17  = s32_1(p256_17) + p256[ 2];
			p256_00=p256[ 0]^data32[ 0];	td32_00=rotl32(data32[ 0], 1);
		p256_18 = ( p256_00+p256_07+p256_09+t256_17        );
		p256_18  = s32_2(p256_18) + p256[ 3];
		p256_19 = ( p256_00+t256_21        -p256_10+p256_13);
		p256_19  = s32_3(p256_19) + p256[ 4];
			p256_02=p256[ 2]^data32[ 2];	td32_02=rotl32(data32[ 2], 3);
		p256_20 = ( t256_16+p256_02+p256_09-p256_11        );
		p256_20  = s32_4(p256_20) + p256[ 5];
			p256_03=p256[ 3]^data32[ 3];	td32_03=rotl32(data32[ 3], 4);
		p256_21 = ( p256_03-p256_02+p256_10+t256_17        );
		p256_21  = s32_0(p256_21) + p256[ 6];
			p256_04=p256[ 4]^data32[ 4];	td32_04=rotl32(data32[ 4], 5);
		p256_22 = ( p256_04-p256_00-p256_03-p256_11+p256_13);
		p256_22  = s32_1(p256_22) + p256[ 7];
		p256_23 = ( t256_16-p256_04-p256_05-p256_12        );
		p256_23  = s32_2(p256_23) + p256[ 8];
		p256_24 = ( p256_02-p256_05+t256_19        -p256_15);
		p256_24  = s32_3(p256_24) + p256[ 9];
		p256_25 = ( p256_00-p256_03+p256_06+t256_18        );
		p256_25  = s32_4(p256_25) + p256[10];
		p256_26 = ( t256_21        -p256_04-p256_07+p256_15);
		p256_26  = s32_0(p256_26) + p256[11];
		p256_27 = ( t256_20-p256_00-p256_02        +p256_09);
		p256_27  = s32_1(p256_27) + p256[12];
		p256_28 = ( p256_01+p256_03-p256_06-p256_09+p256_10);
		p256_28  = s32_2(p256_28) + p256[13];
		p256_29 = ( p256_02+p256_04+p256_07+p256_10+p256_11);
		p256_29  = s32_3(p256_29) + p256[14];
		p256_30 = ( p256_03+t256_20        -p256_11-p256_12);
		p256_14  = s32_4(p256_30) + p256[15];
		TempEven32 = p256_14;
		p256_31 = ( p256_12-p256_04+t256_19-p256_09        );
		p256_15  = s32_0(p256_31) + p256[ 0];
		TempOdd32  = p256_15;

		p256_00  = p256_16;
		p256_01  = p256_17;
		p256_02  = p256_18;
		TempEven32+=p256_02;
		p256_03  = p256_19;
		TempOdd32 += p256_03;
		p256_04  = p256_20;
		TempEven32+= p256_04;
		p256_05  = p256_21;
		TempOdd32+= p256_05;
		p256_06  = p256_22;
		TempEven32+= p256_06;
		p256_07  = p256_23;
		TempOdd32 += p256_07;
		p256_08  = p256_24;
		TempEven32+= p256_08;
		p256_09  = p256_25;
		TempOdd32 += p256_09;
		p256_10  = p256_26;
		TempEven32+= p256_10;
		p256_11  = p256_27;
		TempOdd32 += p256_11;
		p256_12  = p256_28;
		TempEven32+= p256_12;
		p256_13  = p256_29;
		TempOdd32 += p256_13;

		/* This is the Message expansion. */
		/* It has 16 rounds.              */
		p256_16  = s32_1(p256_00)    + s32_2(p256_01) + s32_3(p256_02) + s32_0(p256_03);
		p256_17  = s32_1(p256_01)    + s32_2(p256_02) + s32_3(p256_03) + s32_0(p256_04);
        p256_16 += s32_1(p256_04)    + s32_2(p256_05) + s32_3(p256_06) + s32_0(p256_07);
        p256_17 += s32_1(p256_05)    + s32_2(p256_06) + s32_3(p256_07) + s32_0(p256_08);
		p256_16 += s32_1(p256_08)    + s32_2(p256_09) + s32_3(p256_10) + s32_0(p256_11);
		p256_17 += s32_1(p256_09)    + s32_2(p256_10) + s32_3(p256_11) + s32_0(p256_12);
		p256_16 += s32_1(p256_12)    + s32_2(p256_13) + s32_3(p256_14) + s32_0(p256_15);
		p256_17 += s32_1(p256_13)    + s32_2(p256_14) + s32_3(p256_15);
		p256_16 += ((td32_00      + td32_03       + 0x55555550u - td32_10) ^ p256[ 7]);
		XL32 =  p256_16;
		p256_17 += s32_0(p256_16);
		p256_17 +=  ((td32_01      + td32_04      - td32_11 + 0x5aaaaaa5u) ^ p256[ 8]);
		XL32 ^= p256_17;

		/* expand32_22(18); */
		p256_18  = TempEven32 + r32_01(p256_03)  + r32_02(p256_05) //  r32_01(p256_03) performs a shift left by 3 on p256_03 as well, as part of the rotate...
			                  + r32_03(p256_07)  + r32_04(p256_09)
							  + r32_05(p256_11)  + r32_06(p256_13)
							  + r32_07(p256_15)  + s32_4( p256_16 ) + s32_5( p256_17)
							  + ((td32_02 + td32_05 - td32_12 + 0x5ffffffau) ^ p256[ 9]);
		XL32 ^= p256_18;
		/* expand32_21(19); */
		p256_19 = TempOdd32   + r32_01(p256_04)  + r32_02(p256_06)
                              + r32_03(p256_08)  + r32_04(p256_10)
					          + r32_05(p256_12)  + r32_06(p256_14)
					          + r32_07(p256_16)  + s32_4( p256_17 ) + s32_5( p256_18)
					          + ((td32_03 + td32_06 - td32_13 + 0x6555554fu) ^ p256[10]);
		XL32 ^= p256_19;
		TempEven32=TempEven32 + p256_16 - p256_02;
		/* expand32_22(20); */
		p256_20  = TempEven32 + r32_01(p256_05)  + r32_02(p256_07)
			                  + r32_03(p256_09)  + r32_04(p256_11)
							  + r32_05(p256_13)  + r32_06(p256_15)
							  + r32_07(p256_17)  + s32_4( p256_18 ) + s32_5( p256_19)
							  + ((td32_04 + td32_07 - td32_14 + 0x6aaaaaa4u) ^ p256[11]);
		XL32 ^= p256_20;
		TempOdd32 = TempOdd32 + p256_17 - p256_03;
		/* expand32_21(21); */
		p256_21 = TempOdd32   + r32_01(p256_06)  + r32_02(p256_08)
                              + r32_03(p256_10)  + r32_04(p256_12)
					          + r32_05(p256_14)  + r32_06(p256_16)
					          + r32_07(p256_18)  + s32_4( p256_19 ) + s32_5( p256_20)
					          + ((td32_05 + td32_08 - td32_15 + 0x6ffffff9u) ^ p256[12]);
		XL32 ^= p256_21;
		TempEven32 = TempEven32 + p256_18 - p256_04;
		/* expand32_22(22); */
		p256_22  = TempEven32 + r32_01(p256_07)  + r32_02(p256_09)
			                  + r32_03(p256_11)  + r32_04(p256_13)
							  + r32_05(p256_15)  + r32_06(p256_17)
							  + r32_07(p256_19)  + s32_4( p256_20 ) + s32_5( p256_21)
							  + ((td32_06 + td32_09 - td32_00 + 0x7555554eu) ^ p256[13]);
		XL32 ^= p256_22;
		TempOdd32 = TempOdd32 + p256_19 - p256_05;
		/* expand32_21(23); */
		p256_23 = TempOdd32   + r32_01(p256_08)  + r32_02(p256_10)
                              + r32_03(p256_12)  + r32_04(p256_14)
					          + r32_05(p256_16)  + r32_06(p256_18)
					          + r32_07(p256_20)  + s32_4( p256_21 ) + s32_5( p256_22)
					          + ((td32_07 + td32_10 - td32_01 + 0x7aaaaaa3u) ^ p256[14]);
		XL32 ^= p256_23;
		TempEven32 = TempEven32 + p256_20 - p256_06;
		/* expand32_22(24); */
		p256_24  = TempEven32 + r32_01(p256_09)  + r32_02(p256_11)
			                  + r32_03(p256_13)  + r32_04(p256_15)
							  + r32_05(p256_17)  + r32_06(p256_19)
							  + r32_07(p256_21)  + s32_4( p256_22 ) + s32_5( p256_23)
							  + ((td32_08 + td32_11 - td32_02 + 0x7ffffff8u) ^ p256[15]);
		XH32 =  XL32^p256_24;
		TempOdd32 = TempOdd32 + p256_21 - p256_07;
		/* expand32_21(25); */
		p256_25 = TempOdd32   + r32_01(p256_10)  + r32_02(p256_12)
                              + r32_03(p256_14)  + r32_04(p256_16)
					          + r32_05(p256_18)  + r32_06(p256_20)
					          + r32_07(p256_22)  + s32_4( p256_23 ) + s32_5( p256_24)
					          + ((td32_09 + td32_12 - td32_03 + 0x8555554du) ^ p256[ 0]);
		XH32 ^= p256_25;
		TempEven32 = TempEven32 + p256_22 - p256_08;
		/* expand32_22(26); */
		p256_26  = TempEven32 + r32_01(p256_11)  + r32_02(p256_13)
			                  + r32_03(p256_15)  + r32_04(p256_17)
							  + r32_05(p256_19)  + r32_06(p256_21)
							  + r32_07(p256_23)  + s32_4( p256_24 ) + s32_5( p256_25)
							  + ((td32_10 + td32_13 - td32_04 + 0x8aaaaaa2u) ^ p256[ 1]);
		XH32 ^= p256_26;
		TempOdd32 = TempOdd32 + p256_23 - p256_09;
		/* expand32_21(27); */
		p256_27 = TempOdd32   + r32_01(p256_12)  + r32_02(p256_14)
                              + r32_03(p256_16)  + r32_04(p256_18)
					          + r32_05(p256_20)  + r32_06(p256_22)
					          + r32_07(p256_24)  + s32_4( p256_25 ) + s32_5( p256_26)
					          + ((td32_11 + td32_14 - td32_05 + 0x8ffffff7u) ^ p256[ 2]);
		XH32 ^= p256_27;
		TempEven32 = TempEven32 + p256_24 - p256_10;
		/* expand32_22(28); */
		p256_28  = TempEven32 + r32_01(p256_13)  + r32_02(p256_15)
			                  + r32_03(p256_17)  + r32_04(p256_19)
							  + r32_05(p256_21)  + r32_06(p256_23)
							  + r32_07(p256_25)  + s32_4( p256_26 ) + s32_5( p256_27)
							  + ((td32_12 + td32_15 - td32_06 + 0x9555554cu) ^ p256[ 3]);
		XH32 ^= p256_28;
		TempOdd32 = TempOdd32 + p256_25 - p256_11;
		/* expand32_21(29); */
		p256_29 = TempOdd32   + r32_01(p256_14)  + r32_02(p256_16)
                              + r32_03(p256_18)  + r32_04(p256_20)
					          + r32_05(p256_22)  + r32_06(p256_24)
					          + r32_07(p256_26)  + s32_4( p256_27 ) + s32_5( p256_28)
					          + ((td32_13 + td32_00 - td32_07 + 0x9aaaaaa1u) ^ p256[ 4]);
		XH32 ^= p256_29;
		TempEven32 = TempEven32 + p256_26 - p256_12;
		/* expand32_22(30); */
		p256_30  = TempEven32 + r32_01(p256_15)  + r32_02(p256_17)
			                  + r32_03(p256_19)  + r32_04(p256_21)
							  + r32_05(p256_23)  + r32_06(p256_25)
							  + r32_07(p256_27)  + s32_4( p256_28 ) + s32_5( p256_29)
							  + ((td32_14 + td32_01 - td32_08 + 0x9ffffff6u) ^ p256[ 5]);
		XH32 ^= p256_30;
		TempOdd32 = TempOdd32 + p256_27 - p256_13;
		/* expand32_21(31); */
		p256_31 = TempOdd32   + r32_01(p256_16)  + r32_02(p256_18)
                              + r32_03(p256_20)  + r32_04(p256_22)
					          + r32_05(p256_24)  + r32_06(p256_26)
					          + r32_07(p256_28)  + s32_4( p256_29 ) + s32_5( p256_30)
					          + ((td32_15 + td32_02 - td32_09 + 0xa555554bu) ^ p256[ 6]);
		XH32 ^= p256_31;

		/*  Compute the double chaining pipe for the next message block. */
		p256[0] =                       (shl(XH32, 5) ^ shr(p256_16,5) ^ data32[ 0]) + (    XL32    ^ p256_24 ^ p256_00);
		p256[1] =                       (shr(XH32, 7) ^ shl(p256_17,8) ^ data32[ 1]) + (    XL32    ^ p256_25 ^ p256_01);
		p256[2] =                       (shr(XH32, 5) ^ shl(p256_18,5) ^ data32[ 2]) + (    XL32    ^ p256_26 ^ p256_02);
		p256[3] =                       (shr(XH32, 1) ^ shl(p256_19,5) ^ data32[ 3]) + (    XL32    ^ p256_27 ^ p256_03);
		p256[4] =                       (shr(XH32, 3) ^     p256_20    ^ data32[ 4]) + (    XL32    ^ p256_28 ^ p256_04);
		p256[5] =                       (shl(XH32, 6) ^ shr(p256_21,6) ^ data32[ 5]) + (    XL32    ^ p256_29 ^ p256_05);
		p256[6] =                       (shr(XH32, 4) ^ shl(p256_22,6) ^ data32[ 6]) + (    XL32    ^ p256_30 ^ p256_06);
		p256[7] =                       (shr(XH32,11) ^ shl(p256_23,2) ^ data32[ 7]) + (    XL32    ^ p256_31 ^ p256_07);

		p256[ 8] = rotl32(p256[4], 9) + (    XH32     ^     p256_24    ^ data32[ 8]) + (shl(XL32,8) ^ p256_23 ^ p256_08);
		p256[ 9] = rotl32(p256[5],10) + (    XH32     ^     p256_25    ^ data32[ 9]) + (shr(XL32,6) ^ p256_16 ^ p256_09);
		p256[10] = rotl32(p256[6],11) + (    XH32     ^     p256_26    ^ data32[10]) + (shl(XL32,6) ^ p256_17 ^ p256_10);
		p256[11] = rotl32(p256[7],12) + (    XH32     ^     p256_27    ^ data32[11]) + (shl(XL32,4) ^ p256_18 ^ p256_11);
		p256[12] = rotl32(p256[0],13) + (    XH32     ^     p256_28    ^ data32[12]) + (shr(XL32,3) ^ p256_19 ^ p256_12);
		p256[13] = rotl32(p256[1],14) + (    XH32     ^     p256_29    ^ data32[13]) + (shr(XL32,4) ^ p256_20 ^ p256_13);
		p256[14] = rotl32(p256[2],15) + (    XH32     ^     p256_30    ^ data32[14]) + (shr(XL32,7) ^ p256_21 ^ p256_14);
		p256[15] = rotl32(p256[3],16) + (    XH32     ^     p256_31    ^ data32[15]) + (shr(XL32,2) ^ p256_22 ^ p256_15);

		data32 += 16;
	}
	state->unprocessed_bits = (int)databitlen;
	if (databitlen > 0)
	{
		LastBytes = ((~(((- (int)databitlen)>>3) & 0x01ff)) + 1) & 0x01ff;  // LastBytes = Ceil(databitlen / 8)
		memcpy(hashState256(state)->LastPart, data32, LastBytes );
	}
	// #2 Between comments #1 and #2 add algorithm specifics
	return(SUCCESS);
}


HashReturn Final(hashState *state, BitSequence *hashval)
{
	u_int32_t *data32, *p256;
	u_int32_t XL32, XH32, TempEven32, TempOdd32;
    u_int32_t p256_00, p256_01, p256_02, p256_03, p256_04, p256_05, p256_06, p256_07;
    u_int32_t p256_08, p256_09, p256_10, p256_11, p256_12, p256_13, p256_14, p256_15;
    u_int32_t p256_16, p256_17, p256_18, p256_19, p256_20, p256_21, p256_22, p256_23;
    u_int32_t p256_24, p256_25, p256_26, p256_27, p256_28, p256_29, p256_30, p256_31;
    u_int32_t t256_16, t256_17, t256_18, t256_19, t256_20, t256_21;
	u_int32_t td32_00, td32_01, td32_02, td32_03, td32_04, td32_05, td32_06, td32_07;
	u_int32_t td32_08, td32_09, td32_10, td32_11, td32_12, td32_13, td32_14, td32_15;

	u_int64_t *data64;

	DataLength databitlen;

	int LastByte, PadOnePosition;

	LastByte = (int)state->unprocessed_bits >> 3;
	PadOnePosition = 7 - (state->unprocessed_bits & 0x07);
	hashState256(state)->LastPart[LastByte] = hashState256(state)->LastPart[LastByte] & (0xff << (PadOnePosition + 1) )\
		                                    ^ (0x01 << PadOnePosition);
	data64 = (u_int64_t *)hashState256(state)->LastPart;

	if (state->unprocessed_bits < 448)
	{
		memset( (hashState256(state)->LastPart) + LastByte + 1, 0x00, BlueMidnightWish256_BLOCK_SIZE - LastByte - 9 );
		databitlen = BlueMidnightWish256_BLOCK_SIZE * 8;
		data64[7] = state->bits_processed + state->unprocessed_bits;
	}
	else
	{
		memset( (hashState256(state)->LastPart) + LastByte + 1, 0x00, BlueMidnightWish256_BLOCK_SIZE * 2 - LastByte - 9 );
		databitlen = BlueMidnightWish256_BLOCK_SIZE * 16;
		data64[15] = state->bits_processed + state->unprocessed_bits;
	}

	data32   = (u_int32_t *)hashState256(state)->LastPart;
	p256     = hashState256(state)->DoublePipe;
	while (databitlen >= BlueMidnightWish256_BLOCK_SIZE * 8)
	{
		databitlen -= BlueMidnightWish256_BLOCK_SIZE * 8;
		// #1 Between comments #1 and #2 add algorithm specifics
		Compression256();
		data32 += 16;
	}
	// #2 Between comments #1 and #2 add algorithm specifics

	// This is the tweak for Blue Midnight Wish, to be submitted on 15 September 2009.
	// Below is a code for final invocation of the compression function after digesting the
	// whole padded message. Here, the role of the message has the obtained final double pipe, 
	// and the role of the initial double pipe is a constant.
	FinalCompression256();

	memcpy(hashval, p256 + 8, BlueMidnightWish256_DIGEST_SIZE );
	return(SUCCESS);
}

HashReturn Hash(int hashbitlen, const BitSequence *data, DataLength databitlen, BitSequence *hashval)
{
	HashReturn qq;
	hashState state;

	qq = Init(&state, hashbitlen);
	if (qq != SUCCESS) return(qq);
	qq = Update256(&state, data, databitlen);
	if (qq != SUCCESS) return(qq);
	qq = Final(&state, hashval);
	return(qq);
}
